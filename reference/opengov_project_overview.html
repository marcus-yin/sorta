<!-- Measure Q Project Overview Section - OpenGov HTML Snippet -->
<!-- Paste this entire block into OpenGov -->
<!-- Localhost preview: served by server.js -->

<!-- CryptoJS library for token decryption (required for API integration) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- Banner with Logo -->
<div class="mq-banner">
  <img class="mq-logo" src="https://www.santacruzcountyca.gov/Portals/_default/skins/SccMeasureQ/assets/images/SCC_WWPA_Logo_final2.svg" alt="Measure Q Logo" />
  <h3 class="mq-banner-title">Measure Q Grant Proposal Application</h3>
</div>

<div class="mq-card">
  <style>
    .mq-card {
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 18px;
      margin: 14px 0;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
    }
    .mq-h2 {
      font-size: 16px;
      font-weight: 850;
      margin: 0 0 12px;
      padding-left: 10px;
      border-left: 4px solid #1f8a70;
    }
    .mq-sub {
      font-size: 12px;
      color: #475569;
      margin: 0 0 10px;
    }
    .mq-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .mq-col-12 { grid-column: span 12; }
    .mq-col-8 { grid-column: span 8; }
    .mq-col-6 { grid-column: span 6; }
    .mq-col-4 { grid-column: span 4; }
    .mq-col-3 { grid-column: span 3; }
    .mq-col-2 { grid-column: span 2; }
    .mq-divider {
      height: 1px;
      background: #eef2f7;
      margin: 14px 0;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: #0f172a;
      margin: 0 0 6px;
    }
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 11px 12px;
      border: 1px solid #cfd8e3;
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
      outline: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(11, 90, 115, 0.55);
      box-shadow: 0 0 0 4px rgba(11, 90, 115, 0.15);
    }
    .mq-help {
      font-size: 11px;
      color: #475569;
      margin: 6px 0 0;
    }
    .mq-error-message {
      font-size: 11px;
      color: #dc2626;
      margin: 6px 0 0;
      font-weight: 600;
    }
    input.mq-input-error,
    select.mq-input-error,
    textarea.mq-input-error {
      border-color: #dc2626 !important;
      background-color: #fef2f2;
    }
    input.mq-input-error:focus,
    select.mq-input-error:focus,
    textarea.mq-input-error:focus {
      border-color: #dc2626 !important;
      box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.15) !important;
    }
    .mq-word-count {
      font-size: 12px;
      color: #475569;
      margin-top: 6px;
      text-align: right;
      font-weight: 600;
    }
    .mq-word-count.mq-word-count-limit {
      color: #dc3545;
    }
    textarea.mq-word-limit-reached {
      color: #dc3545;
    }
    .mq-hidden {
      display: none !important;
    }
    .mq-section {
      background: #f9fbff;
      border: 1px solid #cfd9e6;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 20px;
    }
    input[type="radio"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }
    .mq-check {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .mq-table-container {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      margin-top: 10px;
    }
    .mq-table {
      width: 100%;
      border-collapse: collapse;
    }
    .mq-table thead {
      background: #1f8a70;
      color: #ffffff;
    }
    .mq-table thead th {
      padding: 12px;
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      border: none;
    }
    .mq-table thead th small {
      font-weight: 400;
      font-size: 11px;
      display: block;
      margin-top: 4px;
    }
    .mq-table tbody td {
      padding: 12px;
      border-top: 1px solid #eef2f7;
      font-size: 13px;
      color: #0f172a;
      vertical-align: middle;
    }
    .mq-table tbody tr:hover {
      background-color: #f9fbff;
    }
    .mq-table tbody td input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #cfd8e3;
      border-radius: 8px;
      font-size: 13px;
      background: #fff;
      box-sizing: border-box;
      min-width: 0;
    }
    .mq-table tbody td input[type="number"]:focus {
      border-color: rgba(11, 90, 115, 0.55);
      box-shadow: 0 0 0 3px rgba(11, 90, 115, 0.15);
      outline: none;
    }
    .mq-table tbody td:first-child {
      font-weight: 600;
      color: #0f172a;
    }
    .mq-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eef2f7;
    }
    .mq-button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(11, 90, 115, 0.25);
      background: rgba(11, 90, 115, 0.08);
      color: #09495d;
      font-weight: 750;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.05s ease, background 0.15s ease;
    }
    .mq-button:hover {
      background: rgba(11, 90, 115, 0.14);
    }
    .mq-button:active {
      transform: translateY(1px);
    }
    .mq-button-primary {
      background: rgba(11, 90, 115, 0.15);
      border-color: rgba(11, 90, 115, 0.4);
      color: #09495d;
    }
    .mq-button-primary:hover {
      background: rgba(11, 90, 115, 0.22);
    }
    @media (max-width: 860px) {
      .mq-col-8, .mq-col-6, .mq-col-4, .mq-col-3, .mq-col-2 {
        grid-column: span 12;
      }
    }
    /* Banner Section */
    .mq-banner {
      background: linear-gradient(135deg, #1f8a70 0%, #0b5a73 100%);
      padding: 24px 20px;
      margin: 0 0 20px 0;
      text-align: center;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.1);
    }
    .mq-logo {
      height: 72px;
      max-width: 100%;
      margin-bottom: 12px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .mq-banner-title {
      color: #ffffff;
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    @media (max-width: 860px) {
      .mq-banner {
        padding: 20px 16px;
      }
      .mq-logo {
        height: 56px;
        margin-bottom: 10px;
      }
      .mq-banner-title {
        font-size: 18px;
      }
    }
    /* Status Section */
    .mq-status-container {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
    }
    .mq-status-steps {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      padding: 0 10px;
    }
    .mq-status-line {
      position: absolute;
      top: 24px;
      left: 0;
      right: 0;
      height: 3px;
      background: #e2e8f0;
      z-index: 0;
    }
    .mq-status-line-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #1f8a70 0%, #0b5a73 100%);
      z-index: 1;
      transition: width 0.6s ease;
    }
    .mq-status-step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      max-width: 140px;
    }
    .mq-status-step-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      background: #ffffff;
      border: 3px solid #e2e8f0;
      color: #475569;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    .mq-status-step.active .mq-status-step-icon {
      background: #1f8a70;
      border-color: #1f8a70;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(31, 138, 112, 0.3);
      transform: scale(1.08);
    }
    .mq-status-step-label {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      text-align: center;
      margin-top: 4px;
      line-height: 1.3;
    }
    .mq-status-step.active .mq-status-step-label {
      color: #1f8a70;
    }
    @media (max-width: 860px) {
      .mq-status-steps {
        padding: 0 5px;
      }
      .mq-status-step-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      .mq-status-step-label {
        font-size: 11px;
      }
      .mq-status-step {
        max-width: 100px;
      }
    }
    
    /* Print styles for PDF generation */
    @media print {
      /* Hide elements that shouldn't be in PDF */
      .mq-actions,
      .mq-button {
        display: none !important;
      }
      
      /* Page break control */
      .mq-section {
        page-break-inside: avoid;
        break-inside: avoid;
        margin-bottom: 20px;
      }
      
      .mq-banner {
        page-break-after: avoid;
      }
      
      .mq-status-container {
        page-break-inside: avoid;
        page-break-after: avoid;
      }
      
      /* Ensure text areas and inputs are visible */
      textarea,
      input,
      select {
        border: 1px solid #ccc !important;
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      /* Adjust layout for print */
      .mq-card {
        box-shadow: none;
        border: none;
        padding: 10px;
      }
      
      /* Ensure proper spacing */
      .mq-grid {
        page-break-inside: avoid;
      }
      
      .mq-col-12,
      .mq-col-8,
      .mq-col-6,
      .mq-col-4,
      .mq-col-3,
      .mq-col-2 {
        page-break-inside: avoid;
      }
      
      /* Keep labels with their inputs */
      label {
        page-break-after: avoid;
      }
      
      /* Table print handling */
      table {
        page-break-inside: auto;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      thead {
        display: table-header-group;
      }
      
      /* Avoid orphaned content */
      h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid;
      }
      
      .mq-h2 {
        page-break-after: avoid;
      }
      
      /* Map should not print (it won't work properly anyway) */
      #mq_map {
        display: none;
      }
    }
  </style>

  <!-- Status Section -->
  <div class="mq-status-container">
    <div class="mq-status-steps">
      <div class="mq-status-line">
        <div class="mq-status-line-fill" id="mq_status_line_fill" style="width: 0%"></div>
      </div>

      <div class="mq-status-step active" id="mq_status_step_overview">
        <div class="mq-status-step-icon">1</div>
        <div class="mq-status-step-label">Project<br><small>Overview</small></div>
      </div>

      <div class="mq-status-step" id="mq_status_step_tier">
        <div class="mq-status-step-icon">2</div>
        <div class="mq-status-step-label" id="mq_status_tier_label">Application<br><small>Section</small></div>
      </div>
    </div>
  </div>

  <div class="mq-h2">1. Project Overview</div>

  <!-- Application Record ID (Read-only) -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-6">
        <label for="mq_record_id">Application Record ID</label>
        <input type="text" id="mq_record_id" name="mq_record_id" readonly style="background-color: #f1f5f9; cursor: not-allowed;" />
        <p class="mq-help">This is the unique Record ID of your application.</p>
      </div>
    </div>
  </div>

  <!-- Project Type and Basic Information Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-6">
        <label for="mq_project_type">Project Type <span style="color: #dc2626;">*</span></label>
        <select id="mq_project_type" name="mq_project_type">
          <option value="">Select…</option>
          <option value="Tier 1 Community Catalyst Grant">Tier 1 Community Catalyst Grant</option>
          <option value="Tier 2 Community Impact Grants">Tier 2 Community Impact Grants</option>
          <option value="Tier 2 Pajaro Valley Set-Aside">Tier 2 Pajaro Valley Set-Aside</option>
          <option value="Tier 2 San Vicente Redwoods Set-Aside">Tier 2 San Vicente Redwoods Set-Aside</option>
        </select>
        <div class="mq-help">Your selection will control which application questions are displayed.</div>
      </div>

      <div class="mq-col-12">
        <label for="mq_project_title">Project Title (max 30 words) <span style="color: #dc2626;">*</span></label>
        <textarea id="mq_project_title" name="mq_project_title" rows="2"></textarea>
        <div class="mq-word-count" id="mq_project_title_word_count">0 / 30 words</div>
      </div>

      <div class="mq-col-6">
        <label for="mq_applicant_organization">Applicant Organization <span style="color: #dc2626;">*</span></label>
        <select id="mq_applicant_organization" name="mq_applicant_organization">
          <option value="">Loading vendors…</option>
          <option value="NOT_LISTED">Not listed (vendor registration required prior to award)</option>
        </select>
        <div class="mq-help">If "Not listed", complete the next field.</div>
      </div>

      <div class="mq-col-6 mq-hidden" id="mq_applicant_organization_other_wrap">
        <label for="mq_applicant_organization_other">Applicant Organization – Other (if not listed)</label>
        <input id="mq_applicant_organization_other" name="mq_applicant_organization_other" type="text" />
      </div>
    </div>
  </div>

  <!-- Contact Information Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-6">
        <label for="mq_primary_contact_name">Primary Contact Name <span style="color: #dc2626;">*</span></label>
        <input id="mq_primary_contact_name" name="mq_primary_contact_name" type="text" />
      </div>

      <div class="mq-col-3">
        <label for="mq_primary_contact_title">Primary Contact Title <span style="color: #dc2626;">*</span></label>
        <input id="mq_primary_contact_title" name="mq_primary_contact_title" type="text" />
      </div>

      <div class="mq-col-3">
        <label for="mq_primary_contact_phone">Primary Contact Phone <span style="color: #dc2626;">*</span></label>
        <input id="mq_primary_contact_phone" name="mq_primary_contact_phone" type="tel" pattern="^[\d\s\-\.\(\)]+$" placeholder="(123) 456-7890" title="Please enter a valid phone number" />
        <div class="mq-help">Auto-formats as: (123) 456-7890</div>
        <div id="mq_primary_contact_phone_error" class="mq-error-message" style="display: none;">
          Please enter a valid phone number with at least 10 digits
        </div>
      </div>

      <div class="mq-col-6">
        <label for="mq_primary_contact_email">Primary Contact Email <span style="color: #dc2626;">*</span></label>
        <input id="mq_primary_contact_email" name="mq_primary_contact_email" type="email" pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}" placeholder="email@example.com" title="Please enter a valid email address" />
        <div class="mq-help">Format: email@example.com</div>
        <div id="mq_primary_contact_email_error" class="mq-error-message" style="display: none;">
          Please enter a valid email address (e.g., email@example.com)
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Portal Users Section -->
  <div class="mq-section">
    <div class="mq-h2" style="font-size:15px;margin:0 0 10px;">Additional Portal Users</div>
    <p class="mq-sub" style="margin-top:-6px;">
      Add additional users who should have access to this application portal.
    </p>
    <button type="button" class="mq-button" id="mq_add_portal_user_btn" style="margin-bottom: 15px;">
      + Add Portal User
    </button>
    <div id="mq_portal_users_table_wrap" class="mq-hidden">
      <div class="mq-table-container">
        <table class="mq-table">
          <thead>
            <tr>
              <th style="width: 30%;">First Name</th>
              <th style="width: 30%;">Last Name</th>
              <th style="width: 30%;">Email</th>
              <th style="width: 10%; text-align: center;">Action</th>
            </tr>
          </thead>
          <tbody id="mq_portal_users_tbody">
            <!-- Rows will be added dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Project Location Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-12">
        <label for="mq_project_location">Project Location <span style="color: #dc2626;">*</span></label>
        <input id="mq_project_location" name="mq_project_location" type="text" placeholder="Start typing an address..." />
        <div class="mq-help">Add closest address</div>
      </div>

      <div class="mq-col-6">
        <label for="mq_project_parcel_number">Parcel Number</label>
        <input id="mq_project_parcel_number" name="mq_project_parcel_number" type="text" placeholder="Enter parcel number (APN)" />
      </div>
    </div>
  </div>

  <!-- Map Pin Location Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-12">
        <div class="mq-divider"></div>
        <div class="mq-h2" style="font-size:15px;margin:0 0 10px;">Map Pin Location</div>
        <p class="mq-sub" style="margin-top:-6px;">
          Click on the map to drop a pin (or drag the pin). Latitude/Longitude will auto-fill to 14 decimal places.
        </p>
      </div>

      <div class="mq-col-12">
        <div id="mq_map" style="height:400px;width:100%;border-radius:14px;border:1px solid #e2e8f0;box-shadow:0 10px 24px rgba(2, 6, 23, 0.10);background:#f0f0f0;"></div>
        <p id="mq_latlong_display" class="mq-sub" style="margin-top:8px;"></p>
        
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCOeRTHAvIZeQqGl-lvqgfv-ZsDTroltU&libraries=places&callback=initMqMap" async defer></script>
        <script>
          (function() {
            let mqMap, mqMarker;
            const SANTA_CRUZ = { lat: 36.9741171, lng: -122.0307963 };
            
            // Santa Cruz County bounds (approximate)
            const SANTA_CRUZ_COUNTY_BOUNDS = {
              north: 37.15,
              south: 36.85,
              east: -121.65,
              west: -122.25
            };
            
            // Helper function to check if coordinates are within Santa Cruz County
            // Make it globally accessible for use in autocomplete section
            window.isWithinSantaCruzCounty = function(lat, lng) {
              return lat >= SANTA_CRUZ_COUNTY_BOUNDS.south &&
                     lat <= SANTA_CRUZ_COUNTY_BOUNDS.north &&
                     lng >= SANTA_CRUZ_COUNTY_BOUNDS.west &&
                     lng <= SANTA_CRUZ_COUNTY_BOUNDS.east;
            };
            
            // Also create a local reference for use within this IIFE
            const isWithinSantaCruzCounty = window.isWithinSantaCruzCounty;
            
            function setFields(lat, lng) {
              const latField = document.getElementById('mq_project_latitude');
              const lngField = document.getElementById('mq_project_longitude');
              const display = document.getElementById('mq_latlong_display');
              
              const latFixed = Number(lat).toFixed(14);
              const lngFixed = Number(lng).toFixed(14);
              
              if (latField) latField.value = latFixed;
              if (lngField) lngField.value = lngFixed;
              
              if (display) {
                display.textContent = 'Latitude: ' + latFixed + ' | Longitude: ' + lngFixed;
              }
              
              // Save to localStorage
              if (typeof window.saveDraft === 'function') {
                window.saveDraft();
              }
            }
            
            function placeMarker(location) {
              const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
              const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
              
              // Validate that the location is within Santa Cruz County
              if (!isWithinSantaCruzCounty(lat, lng)) {
                alert('Please select a location within Santa Cruz County.');
                return;
              }
              
              if (mqMarker) {
                mqMarker.setPosition(location);
              } else {
                mqMarker = new google.maps.Marker({
                  position: location,
                  map: mqMap,
                  draggable: true
                });
                
                mqMarker.addListener('dragend', function(e) {
                  const newLat = e.latLng.lat();
                  const newLng = e.latLng.lng();
                  
                  // If dragged outside county, snap back to center of county
                  if (!isWithinSantaCruzCounty(newLat, newLng)) {
                    alert('Please keep the marker within Santa Cruz County.');
                    // Move marker back to center of Santa Cruz County
                    const validPosition = new google.maps.LatLng(SANTA_CRUZ.lat, SANTA_CRUZ.lng);
                    mqMarker.setPosition(validPosition);
                    setFields(SANTA_CRUZ.lat, SANTA_CRUZ.lng);
                    return;
                  }
                  
                  setFields(newLat, newLng);
                });
              }
              setFields(lat, lng);
            }
            
            window.initMqMap = function() {
              const mapEl = document.getElementById('mq_map');
              if (!mapEl || !window.google || !google.maps) return;
              
              // Always default to Santa Cruz County, regardless of previous sessions
              const center = SANTA_CRUZ;
              
              // Create bounds for Santa Cruz County
              const countyBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(SANTA_CRUZ_COUNTY_BOUNDS.south, SANTA_CRUZ_COUNTY_BOUNDS.west),
                new google.maps.LatLng(SANTA_CRUZ_COUNTY_BOUNDS.north, SANTA_CRUZ_COUNTY_BOUNDS.east)
              );
              
              mqMap = new google.maps.Map(mapEl, {
                center: center,
                zoom: 12,
                mapTypeControl: true,
                streetViewControl: false,
                // Restrict viewport to Santa Cruz County
                restriction: {
                  latLngBounds: countyBounds,
                  strictBounds: false, // Allow some flexibility for better UX
                },
                // Set minimum and maximum zoom levels
                minZoom: 10,
                maxZoom: 18
              });
              
              // Fit map to county bounds on load
              mqMap.fitBounds(countyBounds);
              
              // Make map and marker globally accessible for manual coordinate updates
              window.mqMap = mqMap;
              
              mqMap.addListener('click', function(event) {
                const clickedLat = event.latLng.lat();
                const clickedLng = event.latLng.lng();
                
                if (isWithinSantaCruzCounty(clickedLat, clickedLng)) {
                  placeMarker(event.latLng);
                } else {
                  alert('Please click on a location within Santa Cruz County.');
                }
              });
              
              // Initialize marker at Santa Cruz County default location
              const position = new google.maps.LatLng(center.lat, center.lng);
              placeMarker(position);
              window.mqMarker = mqMarker;
              
              // Trigger autocomplete initialization after map is ready
              if (window.initMqAutocomplete) {
                window.initMqAutocomplete();
              }
            };
          })();
        </script>
      </div>

      <div class="mq-col-6">
        <label for="mq_project_latitude">Project Latitude (14 decimal places)</label>
        <input id="mq_project_latitude" name="mq_project_latitude" type="number" step="0.00000000000001" min="-90" max="90" placeholder="e.g., 36.97411710000000" />
      </div>

      <div class="mq-col-6">
        <label for="mq_project_longitude">Project Longitude (14 decimal places)</label>
        <input id="mq_project_longitude" name="mq_project_longitude" type="number" step="0.00000000000001" min="-180" max="180" placeholder="e.g., -122.03079630000000" />
      </div>
      
      <script>
        // Initialize Google Places Autocomplete
        window.initMqAutocomplete = function() {
          const addressInput = document.getElementById('mq_project_location');
          if (!addressInput) {
            // Retry if input not ready yet
            setTimeout(window.initMqAutocomplete, 100);
            return;
          }
          
          // Wait for Google Maps Places API to load
          if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
            // Retry after a short delay
            setTimeout(window.initMqAutocomplete, 100);
            return;
          }
          
          // Check if autocomplete already initialized
          if (addressInput.dataset.autocompleteInitialized === 'true') {
            return;
          }
          
          // Create autocomplete object restricted to Santa Cruz County, CA
          const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            types: ['address'], // Restrict to addresses
            componentRestrictions: { 
              country: 'us'
            },
            fields: ['formatted_address', 'geometry', 'address_components'],
            // Set bounds to Santa Cruz County to bias results (strongly favor local results)
            bounds: new google.maps.LatLngBounds(
              new google.maps.LatLng(36.85, -122.25),
              new google.maps.LatLng(37.15, -121.65)
            ),
            strictBounds: false // Allow addresses outside bounds but prefer within
          });
          
          // Mark as initialized
          addressInput.dataset.autocompleteInitialized = 'true';
          
          // When a place is selected
          autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place.geometry) {
              console.warn('No geometry data available for selected place');
              return;
            }
            
            // Update the address field with formatted address
            addressInput.value = place.formatted_address;
            
            // Get coordinates
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            
            // Validate that the selected place is within Santa Cruz County
            if (window.isWithinSantaCruzCounty && !window.isWithinSantaCruzCounty(lat, lng)) {
              alert('Please select an address within Santa Cruz County.');
              addressInput.value = ''; // Clear the input
              return;
            }
            
            // Update latitude/longitude fields
            const latField = document.getElementById('mq_project_latitude');
            const lngField = document.getElementById('mq_project_longitude');
            if (latField) latField.value = lat.toFixed(14);
            if (lngField) lngField.value = lng.toFixed(14);
            
            // Update map marker
            if (window.mqMap && window.mqMarker) {
              const location = new google.maps.LatLng(lat, lng);
              window.mqMarker.setPosition(location);
              window.mqMap.setCenter(location);
              window.mqMap.setZoom(15);
              
              // Update lat/lng display
              const display = document.getElementById('mq_latlong_display');
              if (display) {
                display.textContent = 'Latitude: ' + lat.toFixed(14) + ' | Longitude: ' + lng.toFixed(14);
              }
            }
            
            // Try to populate jurisdiction/city field based on address components
            if (place.address_components) {
              // Look for city in address components
              for (let i = 0; i < place.address_components.length; i++) {
                const component = place.address_components[i];
                const types = component.types;
                
                // Check for locality (city)
                if (types.indexOf('locality') !== -1) {
                  const cityName = component.long_name;
                  // Check if it matches one of the jurisdiction checkboxes
                  const jurisdictionCheckboxes = document.querySelectorAll('input[name="mq_project_jurisdiction[]"]');
                  jurisdictionCheckboxes.forEach(function(checkbox) {
                    const checkboxValue = checkbox.value;
                    const cityPart = checkboxValue.replace('City of ', '');
                    if (checkboxValue.includes(cityName) || cityName.includes(cityPart)) {
                      checkbox.checked = true;
                      // Trigger change event to show/hide conditional fields
                      if (typeof window.updateConditionalFields === 'function') {
                        window.updateConditionalFields();
                      }
                    }
                  });
                  break;
                }
              }
            }
            
            // Save draft
            if (typeof window.saveDraft === 'function') {
              window.saveDraft();
            }
          });
        };
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            // Try to initialize immediately if Google Maps is already loaded
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
              window.initMqAutocomplete();
            }
            // Otherwise, it will be initialized by the map callback
          });
        } else {
          // DOM already loaded
          if (typeof google !== 'undefined' && google.maps && google.maps.places) {
            window.initMqAutocomplete();
          }
        }
      </script>
      
      <script>
        // Update map marker when coordinates are manually entered
        (function() {
          const latField = document.getElementById('mq_project_latitude');
          const lngField = document.getElementById('mq_project_longitude');
          
          function updateMapMarker() {
            if (window.mqMap && window.mqMarker && latField && lngField) {
              const lat = parseFloat(latField.value);
              const lng = parseFloat(lngField.value);
              if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                // Validate coordinates are within Santa Cruz County
                if (window.isWithinSantaCruzCounty && !window.isWithinSantaCruzCounty(lat, lng)) {
                  alert('Please enter coordinates within Santa Cruz County.');
                  return;
                }
                const position = new google.maps.LatLng(lat, lng);
                window.mqMarker.setPosition(position);
                window.mqMap.setCenter(position);
              }
            }
          }
          
          if (latField) {
            latField.addEventListener('change', updateMapMarker);
            latField.addEventListener('blur', updateMapMarker);
          }
          if (lngField) {
            lngField.addEventListener('change', updateMapMarker);
            lngField.addEventListener('blur', updateMapMarker);
          }
        })();
      </script>
    </div>
  </div>

  <!-- Districts & Representation Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-12">
        <div class="mq-divider"></div>
        <div class="mq-h2" style="font-size:15px;margin:0 0 10px;">Districts & Representation</div>
        <p class="mq-sub" style="margin-top:-6px;">
          Pick the project jurisdiction first. Then select the matching district/representatives for the project location.
        </p>
      </div>

      <div class="mq-col-6">
        <label>Project Jurisdiction / City (must select at least one, check all that apply) <span style="color: #dc2626;">*</span></label>
        <div style="margin-top: 8px;">
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_santa_cruz" name="mq_project_jurisdiction[]" value="City of Santa Cruz" style="margin-right: 8px; width: auto;" />
            <span>City of Santa Cruz</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_watsonville" name="mq_project_jurisdiction[]" value="City of Watsonville" style="margin-right: 8px; width: auto;" />
            <span>City of Watsonville</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_capitola" name="mq_project_jurisdiction[]" value="City of Capitola" style="margin-right: 8px; width: auto;" />
            <span>City of Capitola</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_scotts_valley" name="mq_project_jurisdiction[]" value="City of Scotts Valley" style="margin-right: 8px; width: auto;" />
            <span>City of Scotts Valley</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_unincorporated" name="mq_project_jurisdiction[]" value="Unincorporated Santa Cruz County" style="margin-right: 8px; width: auto;" />
            <span>Unincorporated Santa Cruz County</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_multiple" name="mq_project_jurisdiction[]" value="Multiple jurisdictions / Countywide" style="margin-right: 8px; width: auto;" />
            <span>Multiple jurisdictions / Countywide</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_project_jurisdiction_other" name="mq_project_jurisdiction[]" value="Other / Not sure" style="margin-right: 8px; width: auto;" />
            <span>Other / Not sure</span>
          </label>
        </div>
      </div>

      <div id="mq_jurisdiction_communities_wrap" class="mq-col-12 mq-hidden">
        <label for="mq_jurisdiction_communities">Please describe urban or rural communities, jurisdictions, regions served by the proposed project</label>
        <textarea id="mq_jurisdiction_communities" name="mq_jurisdiction_communities" rows="4"></textarea>
        <div class="mq-help">Show when Unincorporated Santa Cruz County or Multiple jurisdictions / Countywide is selected.</div>
      </div>

      <div id="mq_other_city_council_area_notes_wrap" class="mq-col-12 mq-hidden">
        <label for="mq_city_other_council_area_notes">City Council District</label>
        <textarea id="mq_city_other_council_area_notes" name="mq_city_other_council_area_notes" placeholder="Example: at-large council; ward number; district name; or 'not applicable' if countywide."></textarea>
        <div class="mq-help">Show when Project Jurisdiction is selected.</div>
      </div>

      <div class="mq-col-6">
        <label>Santa Cruz County Supervisor District (check all that apply)</label>
        <p class="mq-help"><a href="https://www.santacruzcountyca.gov/VisionSantaCruz.aspx#HomeCountySvs" target="_blank" style="color: #1f8a70; text-decoration: underline;">View Supervisor District Map →</a></p>
        <div style="margin-top: 8px;">
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_county_supervisor_district_1" name="mq_county_supervisor_district[]" value="District 1 — Manu Koenig" style="margin-right: 8px; width: auto;" />
            <span>District 1 — Manu Koenig</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_county_supervisor_district_2" name="mq_county_supervisor_district[]" value="District 2 — Kimberly De Serpa" style="margin-right: 8px; width: auto;" />
            <span>District 2 — Kimberly De Serpa</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_county_supervisor_district_3" name="mq_county_supervisor_district[]" value="District 3 — Justin Cummings" style="margin-right: 8px; width: auto;" />
            <span>District 3 — Justin Cummings</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_county_supervisor_district_4" name="mq_county_supervisor_district[]" value="District 4 — Felipe Hernandez" style="margin-right: 8px; width: auto;" />
            <span>District 4 — Felipe Hernandez</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="checkbox" id="mq_county_supervisor_district_5" name="mq_county_supervisor_district[]" value="District 5 — Monica Martinez" style="margin-right: 8px; width: auto;" />
            <span>District 5 — Monica Martinez</span>
          </label>
        </div>
      </div>

      <div class="mq-col-12">
        <label for="mq_project_service_location">Please describe where in City or County proposed project will serve <span style="color: #dc2626;">*</span></label>
        <textarea id="mq_project_service_location" name="mq_project_service_location" rows="3"></textarea>
      </div>

      <div class="mq-col-6">
        <label for="mq_state_assembly_district">CA State Assembly District / Representative</label>
        <select id="mq_state_assembly_district" name="mq_state_assembly_district">
          <option value="">Select…</option>
          <option value="Not sure">Not sure</option>
          <option value="AD 28 — Gail Pellerin">AD 28 — Gail Pellerin</option>
          <option value="AD 29 — Robert Rivas">AD 29 — Robert Rivas</option>
          <option value="AD 30 — Dawn Addis">AD 30 — Dawn Addis</option>
        </select>
      </div>

      <div class="mq-col-6">
        <label for="mq_state_senate_district">CA State Senate District / Representative</label>
        <select id="mq_state_senate_district" name="mq_state_senate_district">
          <option value="">Select…</option>
          <option value="Not sure">Not sure</option>
          <option value="SD 17 — John Laird">SD 17 — John Laird</option>
        </select>
      </div>

      <div class="mq-col-6">
        <label for="mq_is_dac_sdac">Is this project in a defined DAC (Disadvantaged Community) / SDAC (Severely Disadvantaged Community)?</label>
        <select id="mq_is_dac_sdac" name="mq_is_dac_sdac">
          <option value="">Select…</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <div class="mq-col-12">
        <div class="mq-help" style="margin-top: 8px; font-size: 13px; line-height: 1.5;">
          "Disadvantaged community" means either of the following two definitions:
          <br><br>
          (1) A census tract that ranks within the top 40 percent highest scoring census tracts in the County as identified in the current State's <a href="https://oehha.ca.gov/calenviroscreen/report/calenviroscreen-40" target="_blank" style="color: #1f8a70; text-decoration: underline;">CalEnviroScreen</a>, or
          <br><br>
          (2) A census tract identified as disadvantaged in the United States Council on Environmental Quality <a href="https://public-environmental-data-partners.github.io/j40-cejst-2/en/#3/33.47/-97.5" target="_blank" style="color: #1f8a70; text-decoration: underline;">Climate and Economic Justice Screening Tool</a>.
        </div>
      </div>

      <div id="mq_dac_sdac_fields_container" style="display: none;">
        <div class="mq-col-3">
          <label for="mq_dac_status">DAC Status (Disadvantaged Community)</label>
          <select id="mq_dac_status" name="mq_dac_status">
            <option value="">Select…</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="Not sure">Not sure</option>
          </select>
        </div>

        <div class="mq-col-3">
          <label for="mq_sdac_status">SDAC Status (Severely Disadvantaged Community)</label>
          <select id="mq_sdac_status" name="mq_sdac_status">
            <option value="">Select…</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="Not sure">Not sure</option>
          </select>
        </div>

        <div class="mq-col-12">
          <label for="mq_dac_sdac_notes">DAC/SDAC Notes (census tract, tool used, etc.)</label>
          <textarea id="mq_dac_sdac_notes" name="mq_dac_sdac_notes"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Environmental Compliance and Permitting Section -->
  <div class="mq-section">
    <div class="mq-h2" style="font-size:15px;margin:0 0 10px;">Environmental Compliance and Permitting Status</div>
    <div class="mq-grid">
      <div class="mq-col-12">
        <label>What is the status of the environmental documentation for this project, check the most appropriate box? Please provide documentation of environmental compliance if applicable. Environmental permits are not required prior to grant award. <span style="color: #dc2626;">*</span></label>
        <div style="margin-top: 10px;">
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_none" name="mq_env_doc_status" value="No CEQA/NEPA work initiated" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>No CEQA/NEPA work initiated</span>
          </label>
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_initial_study" name="mq_env_doc_status" value="Initial Study Completed" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>Initial Study Completed, date of completion: </span>
            <input type="text" id="mq_env_doc_initial_study_date" name="mq_env_doc_initial_study_date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" maxlength="10" style="margin-left: 8px; width: 150px; flex-shrink: 0; display: none;" />
          </label>
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_negative_declaration" name="mq_env_doc_status" value="Negative Declaration" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>Negative Declaration, date of certification: </span>
            <input type="text" id="mq_env_doc_negative_declaration_date" name="mq_env_doc_negative_declaration_date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" maxlength="10" style="margin-left: 8px; width: 150px; flex-shrink: 0; display: none;" />
          </label>
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_categorically_exempt" name="mq_env_doc_status" value="Categorically Exempt" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>Categorically Exempt, date of certification: </span>
            <input type="text" id="mq_env_doc_categorically_exempt_date" name="mq_env_doc_categorically_exempt_date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" maxlength="10" style="margin-left: 8px; width: 150px; flex-shrink: 0; display: none;" />
          </label>
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_in_process" name="mq_env_doc_status" value="CEQA/NEPA in process" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>CEQA/NEPA in process, expected date of completion: </span>
            <input type="text" id="mq_env_doc_in_process_date" name="mq_env_doc_in_process_date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" maxlength="10" style="margin-left: 8px; width: 150px; flex-shrink: 0; display: none;" />
          </label>
          <label class="mq-check" style="display: flex; align-items: flex-start; margin-bottom: 12px;">
            <input type="radio" id="mq_env_doc_completed" name="mq_env_doc_status" value="CEQA/NEPA completed" style="margin-top: 4px; margin-right: 8px; width: auto;" />
            <span>CEQA/NEPA completed, date of completion: </span>
            <input type="text" id="mq_env_doc_completed_date" name="mq_env_doc_completed_date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" maxlength="10" style="margin-left: 8px; width: 150px; flex-shrink: 0; display: none;" />
          </label>
        </div>
      </div>

      <div class="mq-col-12">
        <div class="mq-divider" style="margin: 20px 0;"></div>
        <label style="margin-bottom: 12px;">Permits Necessary for Project Implementation <span style="color: #dc2626;">*</span></label>
        <div class="mq-table-container" style="margin-top: 10px;">
          <table class="mq-table">
            <thead>
              <tr>
                <th style="width: 20%;">AGENCY<br><small style="font-weight: 400; font-size: 11px;">identify permits necessary for project implementation</small></th>
                <th style="width: 8%; text-align: center;">YES</th>
                <th style="width: 8%; text-align: center;">NO</th>
                <th style="width: 8%; text-align: center;">NA</th>
                <th style="width: 8%; text-align: center;">NOT SURE</th>
                <th style="width: 24%;">COMMENT</th>
                <th style="width: 24%;">STATUS</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>California Fish and Wildlife</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_ca_fish_wildlife_yes" name="mq_perm_ca_fish_wildlife" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_ca_fish_wildlife_no" name="mq_perm_ca_fish_wildlife" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_ca_fish_wildlife_na" name="mq_perm_ca_fish_wildlife" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_ca_fish_wildlife_notsure" name="mq_perm_ca_fish_wildlife" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_ca_fish_wildlife_comment" name="mq_perm_ca_fish_wildlife_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_ca_fish_wildlife_status" name="mq_perm_ca_fish_wildlife_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
              <tr>
                <td>State Water Control Resources Board</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_state_water_yes" name="mq_perm_state_water" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_state_water_no" name="mq_perm_state_water" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_state_water_na" name="mq_perm_state_water" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_state_water_notsure" name="mq_perm_state_water" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_state_water_comment" name="mq_perm_state_water_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_state_water_status" name="mq_perm_state_water_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
              <tr>
                <td>US Fish and Wildlife</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_us_fish_wildlife_yes" name="mq_perm_us_fish_wildlife" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_us_fish_wildlife_no" name="mq_perm_us_fish_wildlife" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_us_fish_wildlife_na" name="mq_perm_us_fish_wildlife" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_us_fish_wildlife_notsure" name="mq_perm_us_fish_wildlife" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_us_fish_wildlife_comment" name="mq_perm_us_fish_wildlife_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_us_fish_wildlife_status" name="mq_perm_us_fish_wildlife_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
              <tr>
                <td>City/County Construction Permits</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_city_county_yes" name="mq_perm_city_county" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_city_county_no" name="mq_perm_city_county" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_city_county_na" name="mq_perm_city_county" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_city_county_notsure" name="mq_perm_city_county" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_city_county_comment" name="mq_perm_city_county_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_city_county_status" name="mq_perm_city_county_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
              <tr>
                <td>Coastal Commission</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_coastal_yes" name="mq_perm_coastal" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_coastal_no" name="mq_perm_coastal" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_coastal_na" name="mq_perm_coastal" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_coastal_notsure" name="mq_perm_coastal" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_coastal_comment" name="mq_perm_coastal_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_coastal_status" name="mq_perm_coastal_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
              <tr>
                <td>Other</td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_other_yes" name="mq_perm_other" value="Yes" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_other_no" name="mq_perm_other" value="No" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_other_na" name="mq_perm_other" value="NA" style="width: auto;" />
                </td>
                <td style="text-align: center;">
                  <input type="radio" id="mq_perm_other_notsure" name="mq_perm_other" value="Not sure" style="width: auto;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_other_comment" name="mq_perm_other_comment" placeholder="Enter comment" style="width: 100%;" />
                </td>
                <td>
                  <input type="text" id="mq_perm_other_status" name="mq_perm_other_status" placeholder="Enter status" style="width: 100%;" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="mq-col-12">
        <label for="mq_permit_preparations">Please describe any permit preparations or relevant experience with this type of permit process <span style="color: #dc2626;">*</span></label>
        <textarea id="mq_permit_preparations" name="mq_permit_preparations" rows="4"></textarea>
      </div>
    </div>
  </div>

  <!-- Project Details Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-2">
        <label for="mq_project_duration">Estimated Project Duration Unit <span style="color: #dc2626;">*</span></label>
        <select id="mq_project_duration" name="mq_project_duration">
          <option value="">Select…</option>
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
          <option value="months">Months</option>
          <option value="quarters">Quarters</option>
          <option value="years">Years</option>
        </select>
      </div>

      <div class="mq-col-2">
        <label for="mq_duration_amount">Duration Amount <span style="color: #dc2626;">*</span></label>
        <input id="mq_duration_amount" name="mq_duration_amount" type="number" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" placeholder="Enter number" />
      </div>

      <div class="mq-col-2">
        <label for="mq_can_start_upon_award">Can project start upon grant award? <span style="color: #dc2626;">*</span></label>
        <select id="mq_can_start_upon_award" name="mq_can_start_upon_award">
          <option value="">Select…</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <div class="mq-col-12">
        <label for="mq_project_readiness_delays">Please describe project readiness delays or dependencies (max 300 words) <span style="color: #dc2626;">*</span></label>
        <textarea id="mq_project_readiness_delays" name="mq_project_readiness_delays" rows="3"></textarea>
        <div class="mq-word-count" id="mq_project_readiness_delays_word_count">0 / 300 words</div>
      </div>

      <div class="mq-col-6">
        <label for="mq_effectiveness_metric">Project Effectiveness Metric <span style="color: #dc2626;">*</span></label>
        <select id="mq_effectiveness_metric" name="mq_effectiveness_metric">
          <option value="">Select…</option>
          <option value="Acres treated">Acres treated</option>
          <option value="Miles treated">Miles treated</option>
          <option value="Residents protected">Residents protected</option>
          <option value="Population served">Population served</option>
          <option value="Outreach population">Outreach population</option>
          <option value="Education population">Education population</option>
          <option value="Base">Base</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div id="mq_effectiveness_metric_other_wrap" class="mq-col-6 mq-hidden">
        <label for="mq_effectiveness_metric_other">Effectiveness Metric – Other (if applicable)</label>
        <input id="mq_effectiveness_metric_other" name="mq_effectiveness_metric_other" type="text" />
      </div>

      <div class="mq-col-4">
        <label for="mq_effectiveness_metric_base_value">Estimated Effectiveness Value <span style="color: #dc2626;">*</span></label>
        <input id="mq_effectiveness_metric_base_value" name="mq_effectiveness_metric_base_value" type="text" />
      </div>
    </div>
  </div>

  <!-- Funding Request and Budget Section -->
  <div class="mq-section">
    <div class="mq-h2" style="font-size:15px;margin:0 0 10px;">Funding Request and Budget</div>
    
    <div class="mq-table-container">
      <table class="mq-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Measure Q Funds Requested (USD)</th>
            <th>Match (Cash) (USD)</th>
            <th>In-Kind (USD)</th>
            <th>Total (USD)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Personnel</td>
            <td><input type="number" id="mq_budget_personnel_measureq" name="mq_budget_personnel_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_personnel_match" name="mq_budget_personnel_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_personnel_inkind" name="mq_budget_personnel_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_personnel_total" name="mq_budget_personnel_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Fringe Benefits</td>
            <td><input type="number" id="mq_budget_fringe_measureq" name="mq_budget_fringe_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_fringe_match" name="mq_budget_fringe_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_fringe_inkind" name="mq_budget_fringe_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_fringe_total" name="mq_budget_fringe_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Travel</td>
            <td><input type="number" id="mq_budget_travel_measureq" name="mq_budget_travel_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_travel_match" name="mq_budget_travel_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_travel_inkind" name="mq_budget_travel_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_travel_total" name="mq_budget_travel_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Equipment</td>
            <td><input type="number" id="mq_budget_equipment_measureq" name="mq_budget_equipment_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_equipment_match" name="mq_budget_equipment_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_equipment_inkind" name="mq_budget_equipment_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_equipment_total" name="mq_budget_equipment_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Supplies</td>
            <td><input type="number" id="mq_budget_supplies_measureq" name="mq_budget_supplies_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_supplies_match" name="mq_budget_supplies_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_supplies_inkind" name="mq_budget_supplies_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_supplies_total" name="mq_budget_supplies_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Contractual / Consultants</td>
            <td><input type="number" id="mq_budget_contractual_measureq" name="mq_budget_contractual_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_contractual_match" name="mq_budget_contractual_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_contractual_inkind" name="mq_budget_contractual_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_contractual_total" name="mq_budget_contractual_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Construction</td>
            <td><input type="number" id="mq_budget_construction_measureq" name="mq_budget_construction_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_construction_match" name="mq_budget_construction_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_construction_inkind" name="mq_budget_construction_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_construction_total" name="mq_budget_construction_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Other Direct Costs</td>
            <td><input type="number" id="mq_budget_other_direct_measureq" name="mq_budget_other_direct_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_other_direct_match" name="mq_budget_other_direct_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_other_direct_inkind" name="mq_budget_other_direct_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_other_direct_total" name="mq_budget_other_direct_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
          <tr>
            <td>Indirect Costs</td>
            <td><input type="number" id="mq_budget_indirect_measureq" name="mq_budget_indirect_measureq" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_indirect_match" name="mq_budget_indirect_match" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_indirect_inkind" name="mq_budget_indirect_inkind" min="0" step="1" oninput="this.value = Math.round(this.value) || '';" /></td>
            <td><input type="number" id="mq_budget_indirect_total" name="mq_budget_indirect_total" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" /></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mq-grid" style="margin-top: 20px;">
      <div class="mq-col-6">
        <label for="mq_total_funding_requested_usd">Total Funding Requested (USD) <span style="color: #dc2626;">*</span></label>
        <input id="mq_total_funding_requested_usd" name="mq_total_funding_requested_usd" type="number" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" />
        <div class="mq-help" style="margin-top: 6px;">
          Total Funding Requested must be greater than $0 to save and submit. This field is automatically calculated.
        </div>
        <div id="mq_tier1_funding_warning" class="mq-hidden" style="color: #dc3545; font-size: 12px; font-weight: 600; margin-top: 6px;">
          Tier 1 grants are only eligible for $50,000 or less
        </div>
      </div>

      <div class="mq-col-6">
        <label for="mq_total_project_cost_usd">Total Project Cost (USD)</label>
        <input id="mq_total_project_cost_usd" name="mq_total_project_cost_usd" type="number" min="0" step="1" readonly style="background-color: #f1f5f9; cursor: not-allowed;" />
        <div class="mq-help" style="margin-top: 6px;">
          This field is automatically calculated.
        </div>
      </div>
    </div>
  </div>

  <!-- Executive Summary Section -->
  <div class="mq-section">
    <div class="mq-grid">
      <div class="mq-col-12">
        <label for="mq_executive_summary">Executive Summary (250 words) <span style="color: #dc2626;">*</span></label>
        <textarea id="mq_executive_summary" name="mq_executive_summary"></textarea>
        <div class="mq-word-count" id="mq_executive_summary_word_count">0 / 250 words</div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mq-actions">
    <!-- 
      Next page URLs are determined dynamically based on Project Type selection.
      The selected URL is persisted to the resume_url field (via API when integrated).
      The application_stage field stores status values (Draft, In Progress, Submitted).
      URLs are configured in the PROJECT_STAGE_URLS object in the script section.
    -->
    <button type="button" class="mq-button mq-button-primary" id="mq_save_and_continue_btn">
      Save and Continue
    </button>
    <button type="button" class="mq-button" id="mq_save_draft_btn">
      Save Draft
    </button>
    <button type="button" class="mq-button" id="mq_download_pdf_btn">
      Print / Save as PDF
    </button>
  </div>
</div>

<!-- Add Portal User Modal -->
<div id="mq_portal_user_modal" class="mq-modal" style="display: none;">
  <div class="mq-modal-overlay"></div>
  <div class="mq-modal-content">
    <h3 style="margin: 0 0 20px; font-size: 18px; font-weight: 700; color: #0f172a;">Add Portal User</h3>
    <div style="margin-bottom: 15px;">
      <label for="mq_portal_user_first_name" style="display: block; font-size: 12px; font-weight: 700; color: #0f172a; margin-bottom: 6px;">First Name</label>
      <input type="text" id="mq_portal_user_first_name" style="width: 100%; padding: 11px 12px; border: 1px solid #cfd8e3; border-radius: 12px; font-size: 14px; box-sizing: border-box;" />
    </div>
    <div style="margin-bottom: 15px;">
      <label for="mq_portal_user_last_name" style="display: block; font-size: 12px; font-weight: 700; color: #0f172a; margin-bottom: 6px;">Last Name</label>
      <input type="text" id="mq_portal_user_last_name" style="width: 100%; padding: 11px 12px; border: 1px solid #cfd8e3; border-radius: 12px; font-size: 14px; box-sizing: border-box;" />
    </div>
    <div style="margin-bottom: 20px;">
      <label for="mq_portal_user_email" style="display: block; font-size: 12px; font-weight: 700; color: #0f172a; margin-bottom: 6px;">Email</label>
      <input type="email" id="mq_portal_user_email" style="width: 100%; padding: 11px 12px; border: 1px solid #cfd8e3; border-radius: 12px; font-size: 14px; box-sizing: border-box;" />
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button type="button" class="mq-button" id="mq_portal_user_modal_cancel_btn">Cancel</button>
      <button type="button" class="mq-button mq-button-primary" id="mq_portal_user_modal_save_btn">Save</button>
    </div>
  </div>
</div>

<style>
  .mq-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .mq-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1;
  }
  .mq-modal-content {
    position: relative;
    z-index: 2;
    background: #ffffff;
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  @media (max-width: 600px) {
    .mq-modal-content {
      padding: 20px;
      max-width: 100%;
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  const STORAGE_KEY = 'measure_q_draft';
  const PORTAL_USERS_STORAGE_KEY = 'measure_q_portal_users';
  
  // ============================================
  // Additional Portal Users Management
  // ============================================
  
  // Get portal users from localStorage
  const getPortalUsers = function() {
    try {
      const saved = localStorage.getItem(PORTAL_USERS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      console.error('Error loading portal users:', e);
      return [];
    }
  };
  
  // Save portal users to localStorage
  const savePortalUsers = function(users) {
    try {
      localStorage.setItem(PORTAL_USERS_STORAGE_KEY, JSON.stringify(users));
    } catch (e) {
      console.error('Error saving portal users:', e);
    }
  };
  
  // Render portal users table
  const renderPortalUsersTable = function() {
    const tbody = document.getElementById('mq_portal_users_tbody');
    const tableWrap = document.getElementById('mq_portal_users_table_wrap');
    
    if (!tbody || !tableWrap) return;
    
    const users = getPortalUsers();
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    if (users.length === 0) {
      tableWrap.classList.add('mq-hidden');
      return;
    }
    
    // Show table
    tableWrap.classList.remove('mq-hidden');
    
    // Add rows for each user
    users.forEach(function(user, index) {
      const row = document.createElement('tr');
      row.innerHTML = '<td>' + (user.firstName || '') + '</td>' +
                      '<td>' + (user.lastName || '') + '</td>' +
                      '<td>' + (user.email || '') + '</td>' +
                      '<td style="text-align: center;">' +
                      '<button type="button" class="mq-button" style="padding: 6px 10px; font-size: 12px;" data-index="' + index + '" onclick="deletePortalUser(' + index + ')">Remove</button>' +
                      '</td>';
      tbody.appendChild(row);
    });
  };
  
  // Delete a portal user
  window.deletePortalUser = function(index) {
    if (confirm('Are you sure you want to remove this portal user?')) {
      const users = getPortalUsers();
      users.splice(index, 1);
      savePortalUsers(users);
      renderPortalUsersTable();
    }
  };
  
  // Open portal user modal
  const openPortalUserModal = function() {
    const modal = document.getElementById('mq_portal_user_modal');
    if (modal) {
      modal.style.display = 'flex';
      // Clear form fields
      document.getElementById('mq_portal_user_first_name').value = '';
      document.getElementById('mq_portal_user_last_name').value = '';
      document.getElementById('mq_portal_user_email').value = '';
    }
  };
  
  // Close portal user modal
  const closePortalUserModal = function() {
    const modal = document.getElementById('mq_portal_user_modal');
    if (modal) {
      modal.style.display = 'none';
    }
  };
  
  /**
   * Create a new vendor record
   * @param {string} vendorName - Vendor name
   * @returns {Promise<string|null>} Vendor Rid if created successfully, null otherwise
   */
  async function createVendorRecord(vendorName) {
    try {
      const token = await getAuthToken();
      
      if (!token) {
        console.log('[MeasureQ] No token available. Skipping vendor creation.');
        return null;
      }
      
      if (!vendorName || !vendorName.trim()) {
        console.log('[MeasureQ] Vendor name is empty. Skipping vendor creation.');
        return null;
      }
      
      const vendorFields = [
        { Name: 'vendor_name', Value: vendorName.trim() }
      ];
      
      const payload = {
        ApplicationTableKey: VENDOR_TABLE_KEY,
        FieldsList: vendorFields
      };
      
      console.log('[MeasureQ] API: Creating new vendor:', vendorName);
      
      const response = await fetch('https://api.ignatius.io/api/formaction/postdata', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('[MeasureQ] API: Vendor creation failed:', errorText);
        return null;
      }
      
      const result = await response.json();
      const vendorRid = result.recordId || result.Rid;
      console.log('[MeasureQ] API: ✅ Vendor created with Rid:', vendorRid);
      
      // Reload the vendor dropdown to include the new vendor
      await loadApplicantOrganizationOptionsFromApi();
      
      return vendorRid;
    } catch (error) {
      console.error('[MeasureQ] Error creating vendor:', error);
      return null;
    }
  }
  
  /**
   * Check if vendor contact exists by email
   * @param {string} email - Email to search for
   * @returns {Promise<Object|null>} Vendor contact record if found, null if not found
   */
  async function checkVendorContactExists(email) {
    try {
      const token = await getAuthToken();
      
      if (!token) {
        console.log('[MeasureQ] No token available. Skipping vendor contact check.');
        return null;
      }
      
      // Query vendor contacts report filtered by email
      // Note: The report should be configured to filter by email field
      // We'll use simple Filters array which may work better than ConditionGroups
      const payload = {
        ReportId: VENDOR_CONTACTS_REPORT_ID,
        Filters: [] // Report will return all, we'll filter in code if needed
      };
      
      console.log('[MeasureQ] API: Checking if vendor contact exists:', email);
      
      const response = await fetch('https://api.ignatius.io/api/Report/queryreport', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        console.error('[MeasureQ] API: Vendor contact check failed:', response.status);
        return null;
      }
      
      const result = await response.json();
      const allContacts = Array.isArray(result) ? result : (result.data || []);
      
      // Filter contacts by email (since we're getting all records)
      // Email field might be table-prefixed like 'tbl12345_email'
      const matchingContact = allContacts.find(function(contact) {
        // Try to find email field (could be 'email' or 'tbl12345_email')
        let contactEmail = '';
        for (const key in contact) {
          if (key.includes('email') || key === 'email') {
            contactEmail = contact[key];
            break;
          }
        }
        return contactEmail && contactEmail.toLowerCase() === email.toLowerCase();
      });
      
      if (matchingContact) {
        console.log('[MeasureQ] API: Vendor contact found:', matchingContact);
        return matchingContact;
      }
      
      console.log('[MeasureQ] API: Vendor contact not found for:', email);
      return null;
    } catch (error) {
      console.error('[MeasureQ] Error checking vendor contact:', error);
      return null;
    }
  }
  
  /**
   * Create vendor contact record
   * @param {string} vendorRid - Vendor Rid (foreign key)
   * @param {string} firstName - First name
   * @param {string} lastName - Last name
   * @param {string} email - Email address
   * @returns {Promise<Object|null>} Created vendor contact record or null
   */
  async function createVendorContact(vendorRid, firstName, lastName, email) {
    try {
      const token = await getAuthToken();
      
      if (!token) {
        console.log('[MeasureQ] No token available. Skipping vendor contact creation.');
        return null;
      }
      
      const vendorContactFields = [
        { Name: 'related_vendors', Value: String(vendorRid) },
        { Name: 'first_name', Value: firstName },
        { Name: 'last_name', Value: lastName },
        { Name: 'email', Value: email }
      ];
      
      const payload = {
        ApplicationTableKey: VENDOR_CONTACTS_TABLE_KEY,
        FieldsList: vendorContactFields
      };
      
      console.log('[MeasureQ] API: Creating vendor contact:', { vendorRid, firstName, lastName, email });
      
      const response = await fetch('https://api.ignatius.io/api/formaction/postdata', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('[MeasureQ] API: Vendor contact creation failed:', errorText);
        return null;
      }
      
      const result = await response.json();
      console.log('[MeasureQ] API: Vendor contact created with ID:', result.recordId);
      return result;
    } catch (error) {
      console.error('[MeasureQ] Error creating vendor contact:', error);
      return null;
    }
  }
  
  // Save portal user from modal
  const savePortalUserFromModal = async function() {
    const firstName = document.getElementById('mq_portal_user_first_name').value.trim();
    const lastName = document.getElementById('mq_portal_user_last_name').value.trim();
    const email = document.getElementById('mq_portal_user_email').value.trim();
    
    // Validate inputs
    if (!firstName || !lastName || !email) {
      alert('Please fill in all fields.');
      return;
    }
    
    // Basic email validation
    if (!validateEmail(email)) {
      alert('Please enter a valid email address.');
      return;
    }
    
    // Show loading state
    const saveBtn = document.getElementById('mq_portal_user_modal_save_btn');
    const originalBtnText = saveBtn ? saveBtn.textContent : 'Save';
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Checking...';
    }
    
    // Get selected vendor Rid
    const orgDropdown = document.getElementById('mq_applicant_organization');
    let selectedVendorRid = orgDropdown ? orgDropdown.value : null;
    
    // Check if "Not listed" is selected - if so, create a new vendor first
    const isNotListed = selectedVendorRid === 'NOT_LISTED' || 
                        selectedVendorRid === 'Not listed (vendor registration required prior to award)';
    
    if (isNotListed) {
      // Get the vendor name from the "other" field
      const vendorNameInput = document.getElementById('mq_applicant_organization_other');
      const vendorName = vendorNameInput ? vendorNameInput.value.trim() : '';
      
      if (vendorName) {
        try {
          console.log('[MeasureQ] "Not listed" selected - creating new vendor:', vendorName);
          if (saveBtn) saveBtn.textContent = 'Creating vendor...';
          
          // Create new vendor record
          const newVendorRid = await createVendorRecord(vendorName);
          
          if (newVendorRid) {
            console.log('[MeasureQ] ✅ New vendor created, using Rid:', newVendorRid);
            selectedVendorRid = newVendorRid;
            
            // Update the dropdown to show the new vendor
            if (orgDropdown) {
              orgDropdown.value = newVendorRid;
            }
          } else {
            console.warn('[MeasureQ] ⚠️ Failed to create vendor, will skip vendor contact creation');
            selectedVendorRid = null;
          }
        } catch (error) {
          console.error('[MeasureQ] Error creating vendor:', error);
          selectedVendorRid = null;
        }
      } else {
        console.warn('[MeasureQ] "Not listed" selected but no vendor name provided in "Other" field');
        selectedVendorRid = null;
      }
    }
    
    // Now check/create vendor contact if we have a valid vendor Rid
    if (selectedVendorRid && selectedVendorRid !== 'NOT_LISTED' && 
        selectedVendorRid !== 'Not listed (vendor registration required prior to award)') {
      
      try {
        if (saveBtn) saveBtn.textContent = 'Checking contact...';
        
        // Check if vendor contact already exists
        const existingContact = await checkVendorContactExists(email);
        
        if (!existingContact) {
          // Create new vendor contact
          console.log('[MeasureQ] Creating new vendor contact in vendor_contacts table');
          if (saveBtn) saveBtn.textContent = 'Creating contact...';
          
          const newContact = await createVendorContact(selectedVendorRid, firstName, lastName, email);
          
          if (newContact) {
            console.log('[MeasureQ] ✅ Vendor contact created successfully');
          } else {
            console.warn('[MeasureQ] ⚠️ Failed to create vendor contact (API issue), continuing anyway');
          }
        } else {
          console.log('[MeasureQ] ✅ Vendor contact already exists, no need to create');
        }
      } catch (error) {
        console.error('[MeasureQ] Error during vendor contact check/create:', error);
        // Continue anyway - don't block adding portal user if vendor contact fails
      }
    } else if (!selectedVendorRid) {
      console.log('[MeasureQ] Skipping vendor contact creation (no vendor selected or creation failed)');
    }
    
    // Add user to portal users list
    const users = getPortalUsers();
    users.push({
      firstName: firstName,
      lastName: lastName,
      email: email
    });
    savePortalUsers(users);
    
    // Restore button state
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = originalBtnText;
    }
    
    // Close modal and refresh table
    closePortalUserModal();
    renderPortalUsersTable();
  };
  
  // Attach portal user modal event listeners
  const attachPortalUserModalListeners = function() {
    const addBtn = document.getElementById('mq_add_portal_user_btn');
    const cancelBtn = document.getElementById('mq_portal_user_modal_cancel_btn');
    const saveBtn = document.getElementById('mq_portal_user_modal_save_btn');
    
    if (addBtn) {
      addBtn.addEventListener('click', openPortalUserModal);
    }
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', closePortalUserModal);
    }
    
    if (saveBtn) {
      saveBtn.addEventListener('click', savePortalUserFromModal);
    }
    
    // Close modal when clicking overlay
    const modal = document.getElementById('mq_portal_user_modal');
    if (modal) {
      const overlay = modal.querySelector('.mq-modal-overlay');
      if (overlay) {
        overlay.addEventListener('click', closePortalUserModal);
      }
    }
  };
  
  // ============================================
  // API Configuration
  // ============================================
  // TODO: Configure these values when API integration is ready
  const IS_LOCALHOST = ['localhost', '127.0.0.1'].includes(window.location.hostname);
  // Most NCDPS/NCPDS pages in this repo use this AES key for localStorage("token") decryption.
  // Keep a fallback key for older/alternate deployments so decryption doesn't silently fail.
  // NOTE: If you see "Malformed UTF-8 data", it usually means the key doesn't match the stored token.
  const AES_KEY = 'UjXn2r5u8x!A%D*G-KaPdSgVkYp3s6v9';

  const API_CONFIG = {
    // When testing locally, use server.js proxy to avoid browser CORS.
    baseURL: IS_LOCALHOST ? '/proxy' : 'https://api.ignatius.io',
    pushURL: 'YOUR_PUSH_URL_HERE', // Next page URL for application stage
    aesKey: AES_KEY, // Encryption key for token decryption
    
    // Table Keys for all related tables
    applicationTableKey: '97fiqdua5', // Main Application table
    contactsTableKey: 'zpaqofxa8', // Contacts table
    locationsTableKey: 'dt5zkjya5', // Project Location table
    districtsTableKey: 'ronpnl1g1', // Districts & Representation table
    environmentalTableKey: '27ah7yla1', // Environmental Compliance table
    permitsTableKey: 'ppsfsemw6', // Permits table
    timelineTableKey: 'e9mdin2w1', // Project Timeline table
    budgetTableKey: 'yu933jka3', // Budget Items table
    documentsTableKey: '3hzlmokw5', // Documents/Attachments table
    
    // Report IDs for queries
    applicationsReportId: 'weu56yag1', // Applications report
    applicationsIdFieldKey: '8ra3bhiw1', // Field key for 'id' in applications report
    documentsReportId: 'e7b0qoqw6', // Documents report for retrieving files
    contactsReportId: '2f7rsjhg3', // Contacts report
    contactsRelationshipFieldKey: 'j2ezwxsa8', // Field key for 'related_applications' in contacts report
    locationsReportId: '2rzvvb7g8', // Project Locations report
    locationsRelationshipFieldKey: 'hyhbx9ca7', // Field key for 'related_applications' in locations report
    districtsReportId: 'q483xnzg6', // Districts & Representation report
    districtsRelationshipFieldKey: 'rq5b8nqa8', // Field key for 'related_applications' in districts report
    environmentalReportId: 'hggmrhmg2', // Environmental Compliance report
    environmentalRelationshipFieldKey: 'jlxlvioa1', // Field key for 'related_applications' in environmental report
    permitsReportId: 'fflf8sia2', // Permits report
    permitsRelationshipFieldKey: 'pjdn1diq6', // Field key for 'related_applications' in permits report
    timelineReportId: 'vjijmb4w3', // Project Timeline report
    timelineRelationshipFieldKey: 'ihwynjxa8', // Field key for 'related_applications' in timeline report
    budgetReportId: 'qphugioq2', // Budget Items report
    budgetRelationshipFieldKey: 'aemly7yg1', // Field key for 'related_applications' in budget report
    
    // For dropdown population (if needed)
    programsReportId: 'YOUR_PROGRAMS_REPORT_ID_HERE',
    applicationStageFieldKey: 'YOUR_APPLICATION_STAGE_FIELD_KEY_HERE',
    
    // Vendor configuration
    VENDOR_TABLE_KEY: 'n26qz61g1',
    VENDOR_NAME_FIELD_KEY: 'vendor_name',
    VENDOR_REPORT_ID: 'hlecvvbg1',
    VENDOR_CONTACTS_TABLE_KEY: 'qdvjrsbg4',
    VENDOR_CONTACTS_REPORT_ID: 'iirmh2og3'
  };
  
  // Field mapping for API - maps form field IDs (with mq_ prefix) to API field names and table assignments
  const FIELD_MAPPING = {
    // ===== MAIN APPLICATION TABLE FIELDS =====
    'mq_project_type': { name: 'project_type', table: 'application' },
    'mq_project_title': { name: 'project_title', table: 'application' },
    'mq_applicant_organization': { name: 'related_vendors', table: 'application' }, // Stores vendor Rid
    'mq_applicant_organization_other': { name: 'applicant_organization_other', table: 'application' },
    'mq_effectiveness_metric': { name: 'effectiveness_metric', table: 'application' },
    'mq_effectiveness_metric_other': { name: 'effectiveness_metric_other', table: 'application' },
    'mq_effectiveness_metric_base_value': { name: 'effectiveness_metric_base_value', table: 'application' },
    'mq_executive_summary': { name: 'executive_summary', table: 'application' },
    'mq_total_funding_requested_usd': { name: 'total_funding_requested_usd', type: 'NUMBER', table: 'application' },
    'mq_total_project_cost_usd': { name: 'total_project_cost_usd', table: 'application' },
    'application_stage': { name: 'application_stage', table: 'application' }, // Status: Draft, In Progress, Submitted, etc.
    'resume_url': { name: 'resume_url', table: 'application' }, // URL for resume navigation
    
    // ===== CONTACTS TABLE FIELDS =====
    'mq_primary_contact_name': { name: 'primary_contact_name', table: 'contacts' }, // Will be split into first/last
    'mq_primary_contact_title': { name: 'title', table: 'contacts' },
    'mq_primary_contact_phone': { name: 'phone', table: 'contacts' },
    'mq_primary_contact_email': { name: 'email', table: 'contacts' },
    
    // ===== LOCATION TABLE FIELDS =====
    'mq_project_location': { name: 'project_location', table: 'locations' },
    'mq_project_parcel_number': { name: 'project_parcel_number', table: 'locations' },
    'mq_project_latitude': { name: 'project_latitude', table: 'locations' },
    'mq_project_longitude': { name: 'project_longitude', table: 'locations' },
    
    // ===== DISTRICTS TABLE FIELDS =====
    'mq_project_jurisdiction[]': { name: 'project_jurisdiction', type: 'ARRAY', table: 'districts' },
    'mq_jurisdiction_communities': { name: 'jurisdiction_communities', table: 'districts' },
    'mq_city_other_council_area_notes': { name: 'city_council_area_notes', table: 'districts' },
    'mq_county_supervisor_district[]': { name: 'county_supervisor_district', type: 'ARRAY', table: 'districts' },
    'mq_project_service_location': { name: 'project_service_location', table: 'districts' },
    'mq_state_assembly_district': { name: 'state_assembly_district', table: 'districts' },
    'mq_state_senate_district': { name: 'state_senate_district', table: 'districts' },
    'mq_is_dac_sdac': { name: 'is_dac_sdac', table: 'districts' },
    'mq_dac_status': { name: 'dac_status', table: 'districts' },
    'mq_sdac_status': { name: 'sdac_status', table: 'districts' },
    'mq_dac_sdac_notes': { name: 'dac_sdac_notes', table: 'districts' },
    
    // ===== ENVIRONMENTAL TABLE FIELDS =====
    'mq_env_doc_status': { name: 'env_doc_status', table: 'environmental' },
    'mq_permit_preparations': { name: 'permit_preparations', table: 'environmental' },
    
    // ===== TIMELINE TABLE FIELDS =====
    'mq_project_start_date': { name: 'project_start_date', type: 'DATE', table: 'timeline' },
    'mq_duration_amount': { name: 'project_duration_amount', type: 'NUMBER', table: 'timeline' },
    'mq_project_duration': { name: 'project_duration_unit', table: 'timeline' },
    'mq_can_start_upon_award': { name: 'can_start_upon_award', table: 'timeline' },
    'mq_project_readiness_delays': { name: 'project_readiness_delays', table: 'timeline' },
    'mq_project_end_date': { name: 'project_end_date', type: 'DATE', table: 'timeline' }
    
    // Note: Permits and Budget Items are handled separately due to their multi-record nature
  };
  
  // ============================================
  // Token Management
  // ============================================
  // Keep token handling minimal: just read it if present.
  // We can still *attempt* AES decrypt safely and log whether we got an access_token,
  // without throwing or spamming logs.
  let authToken = null;
  let userToken = '';

  function looksLikeCryptoJsSaltedCiphertext(s) {
    // CryptoJS AES default format begins with "Salted__" which base64-encodes as "U2FsdGVkX1".
    return typeof s === 'string' && /^U2FsdGVkX1/.test(s.trim());
  }

  function safeJsonParse(s) {
    try {
      return JSON.parse(s);
    } catch {
      return null;
    }
  }

  function extractAccessTokenFromDecryptedString(decrypted) {
    if (typeof decrypted !== 'string') return '';
    const trimmed = decrypted.trim();
    if (!trimmed) return '';
    const maybeJson = safeJsonParse(trimmed);
    if (maybeJson && typeof maybeJson === 'object') {
      if (maybeJson.access_token) return String(maybeJson.access_token);
      if (maybeJson.token) return String(maybeJson.token);
    }
    return trimmed;
  }

  function bootstrapUserTokenFromLocalStorage() {
    let encryptedToken = '';
    try {
      encryptedToken = localStorage.getItem('token') || '';
    } catch {
      encryptedToken = '';
    }

    if (!encryptedToken) {
      console.log('[MeasureQ] token: no localStorage("token") found');
      return '';
    }
    console.log(`[MeasureQ] token: found localStorage("token") (len=${encryptedToken.length})`);

    if (typeof CryptoJS === 'undefined') {
      console.warn('[MeasureQ] token: CryptoJS not available; cannot decrypt');
      return '';
    }

    const keysToTry = [API_CONFIG?.aesKey].filter(Boolean).map((k) => String(k));

    if (!keysToTry.length) {
      console.warn('[MeasureQ] token: missing AES key(s); cannot decrypt');
      return '';
    }

    for (const key of keysToTry) {
      const keyTag = 'primary';
      try {
        // IMPORTANT: CryptoJS throws "Malformed UTF-8 data" here when the key is wrong.
        const decrypted = CryptoJS.AES.decrypt(encryptedToken, key).toString(CryptoJS.enc.Utf8);
        if (!decrypted) {
          console.warn(`[MeasureQ] token: decrypt returned empty string (key=${keyTag})`);
          continue;
        }

        console.log(`[MeasureQ] token: decrypt ok (key=${keyTag}, len=${decrypted.length})`);

        const extracted = extractAccessTokenFromDecryptedString(decrypted);
        const best = String((extracted || decrypted || '')).trim();
        if (!best) {
          console.warn(`[MeasureQ] token: decrypted value empty after trim (key=${keyTag})`);
          continue;
        }
        if (looksLikeCryptoJsSaltedCiphertext(best)) {
          console.warn(`[MeasureQ] token: decrypted value still looks like ciphertext (key=${keyTag}); refusing`);
          continue;
        }
        if (extracted && extracted !== decrypted) {
          console.log('[MeasureQ] token: extracted access_token from decrypted JSON ✅');
        } else {
          console.log('[MeasureQ] token: using decrypted string ✅');
        }
        return best;
      } catch (e) {
        console.warn(`[MeasureQ] token: decrypt failed (key=${keyTag}): ${e?.message || e}`);
      }
    }

    console.warn('[MeasureQ] token: unable to decrypt token with configured key(s)');
    return '';
  }

  // Simple conditional token bootstrap (runs immediately on script load).
  userToken = bootstrapUserTokenFromLocalStorage();
  
  async function getAuthToken() {
    // Check if token is already available
    if (authToken) {
      return authToken;
    }
    
    // Re-bootstrap on demand if needed (covers cases where token arrives later).
    if (!userToken) {
      userToken = bootstrapUserTokenFromLocalStorage();
    }
    
    if (userToken) {
      authToken = userToken;
      return authToken;
    }

    return null;
  }
  
  // ============================================
  // API Functions
  // ============================================
  
  /**
   * Get user profile from API
   * @returns {Promise<Object>} User profile data
   */
  async function getUserProfile() {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured or token unavailable. Skipping user profile fetch.');
        return null;
      }
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/user/getprofile`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to get user profile: ${response.status} - ${errorText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error getting user profile:', error);
      throw error;
    }
  }
  
  /**
   * Upload a file to OpenGov API
   * @param {File} file - File object to upload
   * @param {string} applicationRid - Record ID of the application
   * @param {string} fieldName - Field name/category for the file (e.g., 't1_attachment_budget')
   * @param {string} documentType - Document type (e.g., 'Tier 1 Attachment', 'Tier 2 Attachment')
   * @returns {Promise<Object>} Upload response with file ID
   */
  async function uploadFile(file, applicationRid, fieldName, documentType) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.documentsTableKey === 'YOUR_DOCUMENTS_TABLE_KEY_HERE') {
        console.log('[MeasureQ] Documents table not configured. Skipping file upload.');
        return null;
      }
      
      console.log(`[MeasureQ] Uploading file: ${file.name} for field: ${fieldName}`);
      
      // Create FormData for multipart upload
      const formData = new FormData();
      formData.append('file', file);
      formData.append('TableKey', API_CONFIG.documentsTableKey);
      formData.append('FieldsList', JSON.stringify([
        { Name: 'related_applications', Value: applicationRid },
        { Name: 'document_type', Value: documentType },
        { Name: 'field_name', Value: fieldName },
        { Name: 'file_name', Value: file.name },
        { Name: 'file_size', Value: String(file.size) },
        { Name: 'mime_type', Value: file.type }
      ]));
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/FormAction/postfile`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`File upload failed: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      console.log(`[MeasureQ] File uploaded successfully:`, result);
      
      return result;
    } catch (error) {
      console.error('[MeasureQ] Error uploading file:', error);
      throw error;
    }
  }
  
  /**
   * Get uploaded files for an application
   * @param {string} applicationRid - Record ID of the application
   * @param {string} fieldName - Optional field name to filter by
   * @returns {Promise<Array>} Array of file metadata
   */
  async function getUploadedFiles(applicationRid, fieldName = null) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.documentsReportId === 'YOUR_DOCUMENTS_REPORT_ID_HERE') {
        console.log('[MeasureQ] Documents report not configured. Skipping file retrieval.');
        return [];
      }
      
      console.log(`[MeasureQ] Fetching uploaded files for application: ${applicationRid}`);
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/Report/queryreport`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          ReportKey: API_CONFIG.documentsReportId,
          Filters: [
            {
              FieldName: 'related_applications',
              Operator: 'equals',
              Value: applicationRid
            }
          ]
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to fetch files: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      let files = result.Data || [];
      
      // Filter by field name if specified
      if (fieldName) {
        files = files.filter(file => {
          const fileFieldName = file.field_name || file[`tbl${API_CONFIG.documentsTableKey}_field_name`];
          return fileFieldName === fieldName;
        });
      }
      
      console.log(`[MeasureQ] Found ${files.length} file(s)`);
      return files;
    } catch (error) {
      console.error('[MeasureQ] Error fetching files:', error);
      return [];
    }
  }
  
  /**
   * Delete a file from OpenGov API
   * @param {string} fileRid - Record ID of the file to delete
   * @returns {Promise<boolean>} Success status
   */
  async function deleteFile(fileRid) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.documentsTableKey === 'YOUR_DOCUMENTS_TABLE_KEY_HERE') {
        console.log('[MeasureQ] Documents table not configured. Skipping file deletion.');
        return false;
      }
      
      console.log(`[MeasureQ] Deleting file: ${fileRid}`);
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/FormAction/deletedata`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          TableKey: API_CONFIG.documentsTableKey,
          RecordId: fileRid
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`File deletion failed: ${response.status} - ${errorText}`);
      }
      
      console.log(`[MeasureQ] File deleted successfully`);
      return true;
    } catch (error) {
      console.error('[MeasureQ] Error deleting file:', error);
      return false;
    }
  }
  
  /**
   * Download/retrieve file URL from OpenGov
   * @param {string} fileRid - Record ID of the file
   * @returns {string} Download URL for the file
   */
  function getFileDownloadUrl(fileRid) {
    return `${API_CONFIG.baseURL}/api/File/download/${fileRid}`;
  }
  
  /**
   * Get dropdown values for a specific field
   * @param {string} fieldId - Field ID to get dropdown values for
   * @returns {Promise<Array>} Array of dropdown options
   */
  async function getDropdownValues(fieldId) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured or token unavailable. Skipping dropdown values fetch.');
        return null;
      }
      console.log(`[MeasureQ] API: GetDropdownValues fieldKey=${fieldId}`);
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/Field/getdropdownvalues?id=${fieldId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to get dropdown values: ${response.status} - ${errorText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error getting dropdown values:', error);
      throw error;
    }
  }

  // ============================================
  // Dynamic dropdown: Project Type
  // ============================================
  const PROJECT_TYPE_FIELD_KEY = 'yygnokag4';
  let mqProjectTypeOriginalHtml = null;
  let mqProjectTypeOptionsLoaded = false;
  let mqProjectTypeOptionsLoading = false;
  
  // ============================================
  // Dynamic dropdown: Applicant Organization (Vendors)
  // ============================================
  const VENDOR_TABLE_KEY = '7ucktphg6'; // Vendors reference table
  const VENDOR_NAME_FIELD_KEY = 'iql4qjsg4'; // Vendor name field in Vendors table
  const VENDOR_REPORT_ID = 'hlecvvbg1'; // Report ID that queries vendors table
  let mqApplicantOrgOriginalHtml = null;
  let mqApplicantOrgOptionsLoaded = false;
  let mqApplicantOrgOptionsLoading = false;
  
  // ============================================
  // Vendor Contacts Table Configuration
  // ============================================
  const VENDOR_CONTACTS_TABLE_KEY = 'qdvjrsbg4'; // Vendor contacts table
  const VENDOR_CONTACTS_REPORT_ID = 'iirmh2og3'; // Report that queries vendor contacts by email
  const VENDOR_NAME_CREATE_FIELD_KEY = 'iql4qjsg4'; // Field key for vendor name when creating new vendor

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  async function loadProjectTypeOptionsFromApi() {
    const select = document.getElementById('mq_project_type');
    if (!select) return;
    if (mqProjectTypeOptionsLoaded || mqProjectTypeOptionsLoading) return;

    if (mqProjectTypeOriginalHtml == null) mqProjectTypeOriginalHtml = select.innerHTML;
    const existingValue = select.value;

    mqProjectTypeOptionsLoading = true;
    select.disabled = true;
    select.innerHTML = '<option value="">Loading project types…</option>';

    try {
      const resp = await getDropdownValues(PROJECT_TYPE_FIELD_KEY);
      if (!resp) {
        // Token unavailable / API not configured. Keep hardcoded options without treating it like "0 results".
        console.warn('[MeasureQ] API: Project Type dropdown fetch skipped (no token / not configured).');
        if (mqProjectTypeOriginalHtml != null) select.innerHTML = mqProjectTypeOriginalHtml;
        select.disabled = false;
        return;
      }
      const list = Array.isArray(resp) ? resp.filter((x) => x && x.IsActive !== false) : [];

      console.log(`[MeasureQ] API: Project Type dropdown values returned count=${list.length}`);

      if (list.length === 0) {
        throw new Error('No dropdown values returned');
      }

      let options = '<option value="">Select…</option>';
      list.forEach((x) => {
        const v = (x.Value ?? x.Name ?? '').toString();
        const n = (x.Name ?? x.Value ?? '').toString();
        if (!v) return;
        options += `<option value="${escapeHtml(v)}">${escapeHtml(n)}</option>`;
      });

      select.innerHTML = options;
      select.disabled = false;

      // Restore prior selection if still present.
      if (existingValue) {
        select.value = existingValue;
      }

      mqProjectTypeOptionsLoaded = true;
    } catch (e) {
      console.error('[MeasureQ] API: failed to load Project Type dropdown values; keeping hardcoded options.', e);
      if (mqProjectTypeOriginalHtml != null) select.innerHTML = mqProjectTypeOriginalHtml;
      select.disabled = false;
      mqProjectTypeOptionsLoaded = false;
    } finally {
      mqProjectTypeOptionsLoading = false;
    }
  }
  
  async function loadApplicantOrganizationOptionsFromApi() {
    const select = document.getElementById('mq_applicant_organization');
    if (!select) return;
    if (mqApplicantOrgOptionsLoaded || mqApplicantOrgOptionsLoading) return;

    if (mqApplicantOrgOriginalHtml == null) mqApplicantOrgOriginalHtml = select.innerHTML;
    const existingValue = select.value;

    mqApplicantOrgOptionsLoading = true;
    select.disabled = true;
    select.innerHTML = '<option value="">Loading vendors…</option>';

    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.warn('[MeasureQ] API: Vendor dropdown fetch skipped (no token / not configured).');
        if (mqApplicantOrgOriginalHtml != null) select.innerHTML = mqApplicantOrgOriginalHtml;
        select.disabled = false;
        mqApplicantOrgOptionsLoading = false;
        return;
      }
      
      // Query the Vendors table via Report
      const payload = {
        ReportId: VENDOR_REPORT_ID,
        Filters: [] // No filters - get all vendors
      };
      
      console.log('[MeasureQ] API: Querying Vendors via report with payload:', payload);
      
      const response = await fetch('https://api.ignatius.io/api/Report/queryreport', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      console.log('[MeasureQ] API: Vendors response status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('[MeasureQ] API: Vendors error response:', errorText);
        throw new Error(`Failed to query vendors: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      console.log('[MeasureQ] API: Vendors raw response:', result);
      
      // Report responses come as an array
      const vendors = Array.isArray(result) ? result : (result.data || result.results || []);
      
      console.log(`[MeasureQ] API: Vendors returned count=${vendors.length}`, vendors);

      if (vendors.length === 0) {
        console.warn('[MeasureQ] API: No vendors found in table');
      }

      // Process vendors and extract Rid and name
      const vendorList = [];
      vendors.forEach((vendor) => {
        // Extract Rid from vendor record
        const vendorRid = vendor.Rid || vendor.rid || vendor.id || vendor.ID;
        
        // Extract vendor name - report responses use table-prefixed field names
        let vendorName = '';
        
        // Try direct field key first
        if (vendor[VENDOR_NAME_FIELD_KEY]) {
          vendorName = vendor[VENDOR_NAME_FIELD_KEY];
        } 
        // Try nested Fields object
        else if (vendor.Fields && vendor.Fields[VENDOR_NAME_FIELD_KEY]) {
          vendorName = vendor.Fields[VENDOR_NAME_FIELD_KEY];
        }
        // Try table-prefixed field name pattern (most common for reports)
        // Look for any field that contains 'vendor_name' in its key
        else {
          for (const key in vendor) {
            if (key.includes('vendor_name')) {
              vendorName = vendor[key];
              break;
            }
          }
        }
        // Final fallback to common field names
        if (!vendorName) {
          vendorName = vendor.vendor_name || vendor.name || vendor.Name || '';
        }
        
        console.log('[MeasureQ] API: Processing vendor:', { vendorRid, vendorName, rawVendor: vendor });
        
        if (vendorRid && vendorName) {
          vendorList.push({ rid: vendorRid, name: vendorName });
        } else {
          console.warn('[MeasureQ] API: Skipping vendor (missing Rid or name):', vendor);
        }
      });
      
      // Sort vendors alphabetically by name (case-insensitive)
      vendorList.sort(function(a, b) {
        const nameA = (a.name || '').toUpperCase();
        const nameB = (b.name || '').toUpperCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });
      
      // Build options HTML from sorted vendor list
      let options = '<option value="">Select…</option>';
      vendorList.forEach(function(vendor) {
        options += `<option value="${escapeHtml(String(vendor.rid))}">${escapeHtml(vendor.name)}</option>`;
      });
      
      // Add "Not listed" option at the end with special value
      options += '<option value="NOT_LISTED">Not listed (vendor registration required prior to award)</option>';

      select.innerHTML = options;
      select.disabled = false;

      // Restore prior selection if still present
      if (existingValue) {
        select.value = existingValue;
      }

      mqApplicantOrgOptionsLoaded = true;
      console.log('[MeasureQ] Loaded', vendorList.length, 'vendors into dropdown (sorted alphabetically)');
    } catch (e) {
      console.error('[MeasureQ] API: failed to load vendor dropdown; keeping hardcoded options.', e);
      if (mqApplicantOrgOriginalHtml != null) select.innerHTML = mqApplicantOrgOriginalHtml;
      select.disabled = false;
      mqApplicantOrgOptionsLoaded = false;
    } finally {
      mqApplicantOrgOptionsLoading = false;
    }
  }
  
  /**
   * Query report for dashboard or data fetching
   * @param {string} reportId - Report ID to query
   * @param {Array} filters - Optional array of filter objects { Key: 'field_key', Value: 'value' }
   * @returns {Promise<Array>} Array of report records
   */
  async function queryReport(reportId, filters = []) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured or token unavailable. Skipping report query.');
        return null;
      }
      
      const payload = {
        ReportId: reportId,
        Filters: filters
      };
      
      const response = await fetch(`${API_CONFIG.baseURL}/api/Report/queryreport`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to query report: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      // Response format: { data: [...] } or [...]
      return Array.isArray(result) ? result : (result.data || []);
    } catch (error) {
      console.error('Error querying report:', error);
      throw error;
    }
  }
  
  /**
   * Convert form data object to API FieldsList format
   * @param {Object} formData - Form data object with field IDs as keys
   * @param {string} nextPageURL - Optional URL for resume_url field (navigation)
   * @returns {Array} Array of { Name: 'field_name', Value: 'value' } objects
   */
  function convertFormDataToFieldsList(formData, nextPageURL = null) {
    const fieldsList = [];
    
    // Iterate through form data and map to API field names
    Object.keys(formData).forEach(function(formFieldId) {
      const value = formData[formFieldId];
      const mapping = FIELD_MAPPING[formFieldId];
      
      // Skip if no mapping exists or value is empty/null/undefined
      if (!mapping || value === null || value === undefined || value === '') {
        return;
      }
      
      // Skip file inputs (they need special handling)
      if (mapping.type === 'FILE') {
        // TODO: Handle file uploads separately if needed
        return;
      }
      
      // Handle arrays (e.g., checkbox groups)
      if (mapping.type === 'ARRAY' && Array.isArray(value)) {
        if (value.length > 0) {
          fieldsList.push({
            Name: mapping.name,
            Value: value.join(', ') // Or use appropriate separator
          });
        }
        return;
      }
      
      // Handle JSON objects/arrays
      if (mapping.type === 'JSON') {
        fieldsList.push({
          Name: mapping.name,
          Value: JSON.stringify(value)
        });
        return;
      }
      
      // Handle regular values
      fieldsList.push({
        Name: mapping.name,
        Value: String(value)
      });
    });
    
    // Add resume_url if nextPageURL is provided (for navigation)
    if (nextPageURL) {
      fieldsList.push({
        Name: 'resume_url',
        Value: nextPageURL
      });
    }
    
    // Always set application_stage to "Draft" for now (can be updated later for workflow)
    if (!fieldsList.some(f => f.Name === 'application_stage')) {
      fieldsList.push({
        Name: 'application_stage',
        Value: 'Draft'
      });
    }
    
    return fieldsList;
  }
  
  /**
   * Submit application data to API (POST for new records, PUT for updates)
   * @param {Array} fieldsData - Array of { Name: 'field_name', Value: 'value' }
   * @param {boolean} isUpdate - If true, uses PUT to update existing record
   * @returns {Promise} API response
   */
  async function submitApplication(fieldsData, isUpdate = false) {
    try {
      const token = await getAuthToken();
      
      // If no token and API is not configured, skip API call
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured or token unavailable. Skipping API submission.');
        return null;
      }
      
      let payload;
      let method;
      let endpoint;
      
      if (isUpdate) {
        // Update existing record (PUT)
        const applicationRecordId = localStorage.getItem('mq_current_application_id');
        
        if (!applicationRecordId) {
          throw new Error('Missing application reference. Cannot update without record ID.');
        }
        
        const rid = Number(applicationRecordId);
        if (Number.isNaN(rid)) {
          throw new Error('Invalid application reference.');
        }
        
        payload = {
          ApplicationTableKey: API_CONFIG.applicationTableKey,
          Where: {
            Rid: rid
          },
          FieldsList: fieldsData
        };
        
        method = 'PUT';
        endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
      } else {
        // Create new record (POST)
        payload = {
          ApplicationTableKey: API_CONFIG.applicationTableKey,
          FieldsList: fieldsData
        };
        
        method = 'POST';
        endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
      }
      
      console.log(`Submitting application data (${method}):`, payload);
      
      const response = await fetch(endpoint, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to submit application: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      
      // Store record ID if this is a new record
      if (!isUpdate && result.recordId) {
        localStorage.setItem('mq_current_application_id', result.recordId);
        console.log('New application record created:', result.recordId);
      }
      
      return result;
    } catch (error) {
      console.error('Error submitting application data:', error);
      throw error;
    }
  }
  
  // ============================================
  // Related Record ID Management
  // ============================================
  
  /**
   * Get stored record IDs for a related table
   * @param {string} tableName - Name of the related table (e.g., 'contacts', 'location', 'budget')
   * @returns {Array|string|null} Array of IDs for multi-record tables, single ID for 1-to-1 tables, or null
   */
  function getRelatedRecordIds(tableName) {
    try {
      const stored = localStorage.getItem(`${tableName}RecordIds`);
      if (!stored) return null;
      
      const parsed = JSON.parse(stored);
      return parsed;
    } catch (error) {
      console.error(`Error getting ${tableName} record IDs:`, error);
      return null;
    }
  }
  
  /**
   * Store record IDs for a related table
   * @param {string} tableName - Name of the related table
   * @param {Array|string} recordIds - Array of record IDs or single record ID
   */
  function storeRelatedRecordIds(tableName, recordIds) {
    try {
      localStorage.setItem(`${tableName}RecordIds`, JSON.stringify(recordIds));
      console.log(`Stored ${tableName} record IDs:`, recordIds);
    } catch (error) {
      console.error(`Error storing ${tableName} record IDs:`, error);
    }
  }
  
  /**
   * Clear all stored related record IDs (useful for new applications)
   */
  function clearAllRelatedRecordIds() {
    const tables = ['contacts', 'location', 'districts', 'environmental', 'permits', 'timeline', 'budget'];
    tables.forEach(function(table) {
      localStorage.removeItem(`${table}RecordIds`);
    });
    console.log('Cleared all related record IDs');
  }
  
  // ============================================
  // Multi-Table Submission Functions
  // ============================================
  
  /**
   * Submit contacts record(s) - handles primary contact + additional portal users
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Array>} Array of created/updated contact records
   */
  async function submitContacts(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token) {
        console.log('No authentication token available. Skipping contacts submission.');
        return null;
      }
      
      if (API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured (AES key not set). Skipping contacts submission.');
        return null;
      }
      
      // Get existing contact record IDs if they exist
      const existingContactIds = getRelatedRecordIds('contacts') || [];
      
      const contacts = [];
      
      // Add primary contact
      const primaryContactName = formData['mq_primary_contact_name'] || '';
      const nameParts = primaryContactName.trim().split(/\s+/);
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';
      
      const primaryContact = {
        Name: 'related_applications',
        Value: String(applicationRecordId)
      };
      
      const primaryContactFields = [
        { Name: 'related_applications', Value: String(applicationRecordId) },
        { Name: 'contact_type', Value: 'Primary Contact' },
        { Name: 'first_name', Value: firstName },
        { Name: 'last_name', Value: lastName },
        { Name: 'email', Value: formData['mq_primary_contact_email'] || '' },
        { Name: 'phone', Value: formData['mq_primary_contact_phone'] || '' },
        { Name: 'title', Value: formData['mq_primary_contact_title'] || '' },
        { Name: 'is_primary', Value: 'true' },
        { Name: 'has_portal_access', Value: 'true' }
      ];
      
      contacts.push(primaryContactFields);
      
      // Add additional portal users
      const portalUsers = getPortalUsers();
      portalUsers.forEach(function(user) {
        const userFields = [
          { Name: 'related_applications', Value: String(applicationRecordId) },
          { Name: 'contact_type', Value: 'Portal User' },
          { Name: 'first_name', Value: user.firstName || '' },
          { Name: 'last_name', Value: user.lastName || '' },
          { Name: 'email', Value: user.email || '' },
          { Name: 'is_primary', Value: 'false' },
          { Name: 'has_portal_access', Value: 'true' }
        ];
        contacts.push(userFields);
      });
      
      // Submit each contact (update if exists, create if new)
      const results = [];
      for (let i = 0; i < contacts.length; i++) {
        const existingRecordId = existingContactIds[i];
        const isUpdate = !!existingRecordId;
        
        let payload, method, endpoint;
        
        if (isUpdate) {
          // UPDATE existing contact - use PUT with Where clause
          const rid = Number(existingRecordId);
          if (Number.isNaN(rid)) {
            console.error('Invalid contact record ID:', existingRecordId);
            continue;
          }
          
          payload = {
            ApplicationTableKey: API_CONFIG.contactsTableKey,
            Where: { Rid: rid },
            FieldsList: contacts[i]
          };
          method = 'PUT';
          endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
        } else {
          // CREATE new contact - use POST
          payload = {
            ApplicationTableKey: API_CONFIG.contactsTableKey,
            FieldsList: contacts[i]
          };
          method = 'POST';
          endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
        }
        
        const response = await fetch(endpoint, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          const recordId = isUpdate ? existingRecordId : result.recordId;
          results.push({ ...result, recordId: recordId });
          console.log(`Contact ${isUpdate ? 'updated' : 'created'}:`, recordId);
        }
      }
      
      return results;
    } catch (error) {
      console.error('Error submitting contacts:', error);
      throw error;
    }
  }
  
  /**
   * Submit location record (1-to-1 relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Object>} API response
   */
  async function submitLocation(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping location submission.');
        return null;
      }
      
      // Get existing record ID if it exists
      const existingRecordId = getRelatedRecordIds('location');
      const isUpdate = !!existingRecordId;
      
      const locationFields = [
        { Name: 'related_applications', Value: String(applicationRecordId) },
        { Name: 'project_location', Value: formData['mq_project_location'] || '' },
        { Name: 'project_parcel_number', Value: formData['mq_project_parcel_number'] || '' },
        { Name: 'project_latitude', Value: formData['mq_project_latitude'] || '' },
        { Name: 'project_longitude', Value: formData['mq_project_longitude'] || '' },
        { Name: 'within_county_bounds', Value: 'true' }
      ];
      
      let payload, method, endpoint;
      
      if (isUpdate) {
        // UPDATE existing record - use PUT with Where clause
        const rid = Number(existingRecordId);
        if (Number.isNaN(rid)) {
          throw new Error('Invalid location record ID.');
        }
        
        payload = {
          ApplicationTableKey: API_CONFIG.locationsTableKey,
          Where: { Rid: rid },
          FieldsList: locationFields
        };
        method = 'PUT';
        endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
      } else {
        // CREATE new record - use POST
        payload = {
          ApplicationTableKey: API_CONFIG.locationsTableKey,
          FieldsList: locationFields
        };
        method = 'POST';
        endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
      }
      
      const response = await fetch(endpoint, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to submit location: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      const recordId = isUpdate ? existingRecordId : result.recordId;
      console.log(`Location ${isUpdate ? 'updated' : 'created'}:`, recordId);
      return { ...result, recordId: recordId };
    } catch (error) {
      console.error('Error submitting location:', error);
      throw error;
    }
  }
  
  /**
   * Submit districts record (1-to-1 relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Object>} API response
   */
  async function submitDistricts(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping districts submission.');
        return null;
      }
      
      // Get existing record ID if it exists
      const existingRecordId = getRelatedRecordIds('districts');
      const isUpdate = !!existingRecordId;
      
      console.log('[SAVE-DISTRICTS] Mode:', isUpdate ? 'UPDATE' : 'CREATE');
      console.log('[SAVE-DISTRICTS] Existing Record ID:', existingRecordId || 'None');
      
      // Handle array fields (checkboxes)
      const projectJurisdiction = formData['mq_project_jurisdiction[]'] || [];
      const supervisorDistrict = formData['mq_county_supervisor_district[]'] || [];
      
      console.log('[SAVE-DISTRICTS] Project Jurisdiction from form:', projectJurisdiction);
      console.log('[SAVE-DISTRICTS] Supervisor District from form:', supervisorDistrict);
      console.log('[SAVE-DISTRICTS] Jurisdiction Communities:', formData['mq_jurisdiction_communities']);
      console.log('[SAVE-DISTRICTS] Service Location:', formData['mq_project_service_location']);
      
      const districtsFields = [
        { Name: 'related_applications', Value: String(applicationRecordId) },
        // Multi-select fields must be sent as comma-separated strings, not arrays
        { Name: 'project_jurisdiction', Value: Array.isArray(projectJurisdiction) ? projectJurisdiction.join(', ') : (projectJurisdiction || '') },
        { Name: 'jurisdiction_communities', Value: formData['mq_jurisdiction_communities'] || '' },
        { Name: 'city_council_area_notes', Value: formData['mq_city_other_council_area_notes'] || '' },
        { Name: 'county_supervisor_district', Value: Array.isArray(supervisorDistrict) ? supervisorDistrict.join(', ') : (supervisorDistrict || '') },
        { Name: 'project_service_location', Value: formData['mq_project_service_location'] || '' },
        { Name: 'state_assembly_district', Value: formData['mq_state_assembly_district'] || '' },
        { Name: 'state_senate_district', Value: formData['mq_state_senate_district'] || '' },
        { Name: 'is_dac_sdac', Value: formData['mq_is_dac_sdac'] || '' },
        { Name: 'dac_status', Value: formData['mq_dac_status'] || '' },
        { Name: 'sdac_status', Value: formData['mq_sdac_status'] || '' },
        { Name: 'dac_sdac_notes', Value: formData['mq_dac_sdac_notes'] || '' }
      ];
      
      console.log('[SAVE-DISTRICTS] Fields being sent to API:', districtsFields);
      
      let payload, method, endpoint;
      
      if (isUpdate) {
        // UPDATE existing record - use PUT with Where clause
        const rid = Number(existingRecordId);
        if (Number.isNaN(rid)) {
          throw new Error('Invalid districts record ID.');
        }
        
        payload = {
          ApplicationTableKey: API_CONFIG.districtsTableKey,
          Where: { Rid: rid },
          FieldsList: districtsFields
        };
        method = 'PUT';
        endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
      } else {
        // CREATE new record - use POST
        payload = {
          ApplicationTableKey: API_CONFIG.districtsTableKey,
          FieldsList: districtsFields
        };
        method = 'POST';
        endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
      }
      
      console.log('[SAVE-DISTRICTS] API Request:', {
        method: method,
        endpoint: endpoint,
        payload: payload
      });
      
      const response = await fetch(endpoint, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      console.log('[SAVE-DISTRICTS] API Response Status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('[SAVE-DISTRICTS] API Error Response:', errorText);
        throw new Error(`Failed to submit districts: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      const recordId = isUpdate ? existingRecordId : result.recordId;
      console.log('[SAVE-DISTRICTS] API Response Data:', result);
      console.log(`[SAVE-DISTRICTS] ✅ Districts ${isUpdate ? 'updated' : 'created'} successfully. Record ID:`, recordId);
      return { ...result, recordId: recordId };
    } catch (error) {
      console.error('Error submitting districts:', error);
      throw error;
    }
  }
  
  /**
   * Submit environmental record (1-to-1 relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Object>} API response
   */
  async function submitEnvironmental(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping environmental submission.');
        return null;
      }
      
      // Get existing record ID if it exists
      const existingRecordId = getRelatedRecordIds('environmental');
      const isUpdate = !!existingRecordId;
      
      const envDocStatus = formData['mq_env_doc_status'] || '';
      
      const environmentalFields = [
        { Name: 'related_applications', Value: String(applicationRecordId) },
        { Name: 'env_doc_status', Value: envDocStatus },
        { Name: 'permit_preparations', Value: formData['mq_permit_preparations'] || '' }
      ];
      
      let payload, method, endpoint;
      
      if (isUpdate) {
        // UPDATE existing record - use PUT with Where clause
        const rid = Number(existingRecordId);
        if (Number.isNaN(rid)) {
          throw new Error('Invalid environmental record ID.');
        }
        
        payload = {
          ApplicationTableKey: API_CONFIG.environmentalTableKey,
          Where: { Rid: rid },
          FieldsList: environmentalFields
        };
        method = 'PUT';
        endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
      } else {
        // CREATE new record - use POST
        payload = {
          ApplicationTableKey: API_CONFIG.environmentalTableKey,
          FieldsList: environmentalFields
        };
        method = 'POST';
        endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
      }
      
      const response = await fetch(endpoint, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to submit environmental: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      const recordId = isUpdate ? existingRecordId : result.recordId;
      console.log(`Environmental ${isUpdate ? 'updated' : 'created'}:`, recordId);
      return { ...result, recordId: recordId };
    } catch (error) {
      console.error('Error submitting environmental:', error);
      throw error;
    }
  }
  
  /**
   * Submit permits records (1-to-many relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Array>} Array of created/updated permit records
   */
  async function submitPermits(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping permits submission.');
        return null;
      }
      
      // Get existing permit record IDs if they exist
      const existingPermitIds = getRelatedRecordIds('permits') || [];
      
      // Define the permits from the form
      const permitAgencies = [
        { name: 'California Fish and Wildlife', formPrefix: 'mq_perm_ca_fish_wildlife' },
        { name: 'State Water Control Resources Board', formPrefix: 'mq_perm_state_water' },
        { name: 'US Fish and Wildlife', formPrefix: 'mq_perm_us_fish_wildlife' },
        { name: 'City/County Construction Permits', formPrefix: 'mq_perm_city_county' },
        { name: 'Coastal Commission', formPrefix: 'mq_perm_coastal' },
        { name: 'Other', formPrefix: 'mq_perm_other' }
      ];
      
      const results = [];
      let permitIndex = 0;
      
      for (let i = 0; i < permitAgencies.length; i++) {
        const agency = permitAgencies[i];
        const permitRequired = formData[agency.formPrefix] || '';
        
        if (!permitRequired) continue; // Skip if no selection made
        
        const existingRecordId = existingPermitIds[permitIndex];
        const isUpdate = !!existingRecordId;
        
        const permitFields = [
          { Name: 'related_applications', Value: String(applicationRecordId) },
          { Name: 'permit_agency', Value: agency.name },
          { Name: 'permit_required', Value: permitRequired },
          { Name: 'permit_comment', Value: formData[agency.formPrefix + '_comment'] || '' },
          { Name: 'permit_status', Value: formData[agency.formPrefix + '_status'] || '' }
        ];
        
        let payload, method, endpoint;
        
        if (isUpdate) {
          // UPDATE existing permit - use PUT with Where clause
          const rid = Number(existingRecordId);
          if (Number.isNaN(rid)) {
            console.error('Invalid permit record ID:', existingRecordId);
            permitIndex++;
            continue;
          }
          
          payload = {
            ApplicationTableKey: API_CONFIG.permitsTableKey,
            Where: { Rid: rid },
            FieldsList: permitFields
          };
          method = 'PUT';
          endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
        } else {
          // CREATE new permit - use POST
          payload = {
            ApplicationTableKey: API_CONFIG.permitsTableKey,
            FieldsList: permitFields
          };
          method = 'POST';
          endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
        }
        
        const response = await fetch(endpoint, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          const recordId = isUpdate ? existingRecordId : result.recordId;
          results.push({ ...result, recordId: recordId });
          console.log(`Permit ${isUpdate ? 'updated' : 'created'} for`, agency.name, ':', recordId);
        }
        
        permitIndex++;
      }
      
      return results;
    } catch (error) {
      console.error('Error submitting permits:', error);
      throw error;
    }
  }
  
  /**
   * Submit timeline record (1-to-1 relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Object>} API response
   */
  async function submitTimeline(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping timeline submission.');
        return null;
      }
      
      // Get existing record ID if it exists
      const existingRecordId = getRelatedRecordIds('timeline');
      const isUpdate = !!existingRecordId;
      
      const timelineFields = [
        { Name: 'related_applications', Value: String(applicationRecordId) },
        { Name: 'project_start_date', Value: formData['mq_project_start_date'] || '' },
        { Name: 'project_duration_amount', Value: formData['mq_duration_amount'] || '' },
        { Name: 'project_duration_unit', Value: formData['mq_project_duration'] || '' },
        { Name: 'can_start_upon_award', Value: formData['mq_can_start_upon_award'] || '' },
        { Name: 'project_readiness_delays', Value: formData['mq_project_readiness_delays'] || '' },
        { Name: 'project_end_date', Value: formData['mq_project_end_date'] || '' }
      ];
      
      let payload, method, endpoint;
      
      if (isUpdate) {
        // UPDATE existing record - use PUT with Where clause
        const rid = Number(existingRecordId);
        if (Number.isNaN(rid)) {
          throw new Error('Invalid timeline record ID.');
        }
        
        payload = {
          ApplicationTableKey: API_CONFIG.timelineTableKey,
          Where: { Rid: rid },
          FieldsList: timelineFields
        };
        method = 'PUT';
        endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
      } else {
        // CREATE new record - use POST
        payload = {
          ApplicationTableKey: API_CONFIG.timelineTableKey,
          FieldsList: timelineFields
        };
        method = 'POST';
        endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
      }
      
      const response = await fetch(endpoint, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to submit timeline: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      const recordId = isUpdate ? existingRecordId : result.recordId;
      console.log(`Timeline ${isUpdate ? 'updated' : 'created'}:`, recordId);
      return { ...result, recordId: recordId };
    } catch (error) {
      console.error('Error submitting timeline:', error);
      throw error;
    }
  }
  
  /**
   * Submit budget items records (1-to-many relationship)
   * @param {string} applicationRecordId - Parent application record ID
   * @param {Object} formData - All form data
   * @returns {Promise<Array>} Array of created/updated budget item records
   */
  async function submitBudget(applicationRecordId, formData) {
    try {
      const token = await getAuthToken();
      
      if (!token || API_CONFIG.aesKey === 'YOUR_AES_KEY_HERE') {
        console.log('API not configured. Skipping budget submission.');
        return null;
      }
      
      // Get existing budget record IDs by category name (object map, not array)
      const existingBudgetIds = getRelatedRecordIds('budget') || {};
      // Handle legacy format: if it's an array, convert to empty object (will create new records)
      const budgetIdsByCategory = Array.isArray(existingBudgetIds) ? {} : existingBudgetIds;
      
      console.log('[SAVE-BUDGET] Existing budget IDs by category:', budgetIdsByCategory);
      
      // Define the budget categories
      const budgetCategories = [
        { name: 'Personnel', formPrefix: 'mq_budget_personnel', sortOrder: 1 },
        { name: 'Fringe Benefits', formPrefix: 'mq_budget_fringe', sortOrder: 2 },
        { name: 'Travel', formPrefix: 'mq_budget_travel', sortOrder: 3 },
        { name: 'Equipment', formPrefix: 'mq_budget_equipment', sortOrder: 4 },
        { name: 'Supplies', formPrefix: 'mq_budget_supplies', sortOrder: 5 },
        { name: 'Contractual / Consultants', formPrefix: 'mq_budget_contractual', sortOrder: 6 },
        { name: 'Construction', formPrefix: 'mq_budget_construction', sortOrder: 7 },
        { name: 'Other Direct Costs', formPrefix: 'mq_budget_other_direct', sortOrder: 8 },
        { name: 'Indirect Costs', formPrefix: 'mq_budget_indirect', sortOrder: 9 }
      ];
      
      const results = [];
      const newBudgetIdsByCategory = {}; // Store IDs by category name for saving
      
      for (let i = 0; i < budgetCategories.length; i++) {
        const category = budgetCategories[i];
        const measureq = parseFloat(formData[category.formPrefix + '_measureq']) || 0;
        const match = parseFloat(formData[category.formPrefix + '_match']) || 0;
        const inkind = parseFloat(formData[category.formPrefix + '_inkind']) || 0;
        const total = measureq + match + inkind;
        
        // Only create record if there's some value
        if (total === 0) continue;
        
        // Look up existing record ID by category name (not by index)
        const existingRecordId = budgetIdsByCategory[category.name];
        const isUpdate = !!existingRecordId;
        
        console.log('[SAVE-BUDGET] Category:', category.name, 'Existing ID:', existingRecordId || 'None', 'Mode:', isUpdate ? 'UPDATE' : 'CREATE');
        
        const budgetFields = [
          { Name: 'related_applications', Value: String(applicationRecordId) },
          { Name: 'budget_category', Value: category.name },
          { Name: 'measureq_funds', Value: String(measureq) },
          { Name: 'match_cash', Value: String(match) },
          { Name: 'in_kind', Value: String(inkind) },
          { Name: 'row_total', Value: String(total) },
          { Name: 'sort_order', Value: String(category.sortOrder) }
        ];
        
        let payload, method, endpoint;
        
        if (isUpdate) {
          // UPDATE existing budget item - use PUT with Where clause
          const rid = Number(existingRecordId);
          if (Number.isNaN(rid)) {
            console.error('Invalid budget record ID for category', category.name, ':', existingRecordId);
            continue; // Skip this category if ID is invalid
          }
          
          payload = {
            ApplicationTableKey: API_CONFIG.budgetTableKey,
            Where: { Rid: rid },
            FieldsList: budgetFields
          };
          method = 'PUT';
          endpoint = `${API_CONFIG.baseURL}/api/FormAction/putdata`;
        } else {
          // CREATE new budget item - use POST
          payload = {
            ApplicationTableKey: API_CONFIG.budgetTableKey,
            FieldsList: budgetFields
          };
          method = 'POST';
          endpoint = `${API_CONFIG.baseURL}/api/formaction/postdata`;
        }
        
        const response = await fetch(endpoint, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          const recordId = isUpdate ? existingRecordId : result.recordId;
          results.push({ ...result, recordId: recordId });
          
          // Store the record ID by category name
          newBudgetIdsByCategory[category.name] = recordId;
          
          console.log(`Budget item ${isUpdate ? 'updated' : 'created'} for`, category.name, ':', recordId);
        }
      }
      
      // Store all budget IDs by category name (not as array)
      if (Object.keys(newBudgetIdsByCategory).length > 0) {
        storeRelatedRecordIds('budget', newBudgetIdsByCategory);
        console.log('[SAVE-BUDGET] ✅ Stored budget IDs by category:', newBudgetIdsByCategory);
      }
      
      return results;
    } catch (error) {
      console.error('Error submitting budget:', error);
      throw error;
    }
  }
  
  /**
   * MASTER ORCHESTRATOR: Submit complete application to all related tables
   * @param {string} nextPageURL - Optional URL for resume_url field (navigation)
   * @param {boolean} isUpdate - If true, updates existing main application
   * @returns {Promise<Object>} Results from all submissions
   */
  async function submitCompleteApplication(nextPageURL = null, isUpdate = false) {
    const results = {
      success: false,
      applicationRecordId: null,
      errors: [],
      relatedRecords: {}
    };
    
    try {
      console.log('=== Starting Complete Application Submission ===');
      console.log('[SAVE] Mode:', isUpdate ? 'UPDATE existing application' : 'CREATE new application');
      console.log('[SAVE] Next Page URL:', nextPageURL || 'None (draft)');
      
      // STEP 1: Collect all form data
      const formData = getAllFields();
      console.log('[SAVE] Form data collected:', Object.keys(formData).length, 'fields');
      console.log('[SAVE] Sample form data (first 10):', Object.keys(formData).slice(0, 10).reduce(function(obj, key) {
        obj[key] = formData[key];
        return obj;
      }, {}));
      
      // STEP 2: Prepare main application fields
      const mainApplicationFields = [];
      console.log('[SAVE] Building main application fields...');
      
      // Add main application table fields
      if (formData['mq_project_type']) {
        mainApplicationFields.push({ Name: 'project_type', Value: formData['mq_project_type'] });
      }
      if (formData['mq_project_title']) {
        mainApplicationFields.push({ Name: 'project_title', Value: formData['mq_project_title'] });
      }
      if (formData['mq_applicant_organization']) {
        // Store vendor Rid, skip if "Not listed"
        const vendorValue = formData['mq_applicant_organization'];
        if (vendorValue && vendorValue !== 'NOT_LISTED') {
          mainApplicationFields.push({ Name: 'related_vendors', Value: vendorValue });
        }
      }
      if (formData['mq_applicant_organization_other']) {
        mainApplicationFields.push({ Name: 'applicant_organization_other', Value: formData['mq_applicant_organization_other'] });
      }
      if (formData['mq_effectiveness_metric']) {
        mainApplicationFields.push({ Name: 'effectiveness_metric', Value: formData['mq_effectiveness_metric'] });
      }
      if (formData['mq_effectiveness_metric_other']) {
        mainApplicationFields.push({ Name: 'effectiveness_metric_other', Value: formData['mq_effectiveness_metric_other'] });
      }
      if (formData['mq_effectiveness_metric_base_value']) {
        mainApplicationFields.push({ Name: 'effectiveness_metric_base_value', Value: formData['mq_effectiveness_metric_base_value'] });
      }
      if (formData['mq_executive_summary']) {
        mainApplicationFields.push({ Name: 'executive_summary', Value: formData['mq_executive_summary'] });
      }
      if (formData['mq_total_funding_requested_usd']) {
        mainApplicationFields.push({ Name: 'total_funding_requested_usd', Value: formData['mq_total_funding_requested_usd'] });
      }
      if (formData['mq_total_project_cost_usd']) {
        mainApplicationFields.push({ Name: 'total_project_cost_usd', Value: formData['mq_total_project_cost_usd'] });
      }
      
      // Add resume_url if nextPageURL is provided (for navigation)
      if (nextPageURL) {
        mainApplicationFields.push({ Name: 'resume_url', Value: nextPageURL });
      }
      
      // Set application_stage to "Draft" (can be updated later for submission workflow)
      mainApplicationFields.push({ Name: 'application_stage', Value: 'Draft' });
      
      // Set application_status to "Draft" when saving (Save Draft or Save and Continue)
      mainApplicationFields.push({ Name: 'application_status', Value: 'Draft' });
      
      console.log('[SAVE] Setting application_status to "Draft"');
      console.log('[SAVE] Main application fields prepared:', mainApplicationFields.length, 'fields');
      console.log('[SAVE] Main application data:', mainApplicationFields);
      
      // STEP 3: Submit main application first (POST or PUT)
      console.log('[SAVE] Submitting main application (', isUpdate ? 'PUT/UPDATE' : 'POST/CREATE', ')...');
      const mainResult = await submitApplication(mainApplicationFields, isUpdate);
      console.log('[SAVE] Main application result:', mainResult);
      
      // If API is not available, mark as success with localStorage only
      if (!mainResult) {
        console.warn('API not available. Data saved to localStorage only.');
        results.success = true;
        results.errors.push({ 
          table: 'API', 
          error: 'API not configured or token unavailable. Data saved locally only.' 
        });
        return results;
      }
      
      const applicationRecordId = isUpdate ? 
        localStorage.getItem('mq_current_application_id') : 
        mainResult.recordId;
      
      results.applicationRecordId = applicationRecordId;
      console.log('[SAVE] ✅ Main application record ID:', applicationRecordId);
      
      // STEP 4: Submit all related records (continue even if some fail)
      console.log('[SAVE] === Starting Child Tables Submission ===');
      
      // Submit contacts
      try {
        console.log('[SAVE] 📝 Submitting contacts table...');
        const contactsResult = await submitContacts(applicationRecordId, formData);
        console.log('[SAVE] Contacts result:', contactsResult);
        results.relatedRecords.contacts = contactsResult;
        
        // Store contact record IDs
        if (contactsResult && Array.isArray(contactsResult)) {
          const contactIds = contactsResult.map(function(r) { return r.recordId; });
          console.log('[SAVE] ✅ Contacts saved. Record IDs:', contactIds);
          storeRelatedRecordIds('contacts', contactIds);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Contacts submission failed:', error);
        results.errors.push({ table: 'contacts', error: error.message });
      }
      
      // Submit location
      try {
        console.log('[SAVE] 📍 Submitting location table...');
        const locationResult = await submitLocation(applicationRecordId, formData);
        console.log('[SAVE] Location result:', locationResult);
        results.relatedRecords.location = locationResult;
        
        // Store location record ID
        if (locationResult && locationResult.recordId) {
          console.log('[SAVE] ✅ Location saved. Record ID:', locationResult.recordId);
          storeRelatedRecordIds('location', locationResult.recordId);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Location submission failed:', error);
        results.errors.push({ table: 'location', error: error.message });
      }
      
      // Submit districts
      try {
        console.log('[SAVE] 🏛️ Submitting districts table...');
        const districtsResult = await submitDistricts(applicationRecordId, formData);
        console.log('[SAVE] Districts result:', districtsResult);
        results.relatedRecords.districts = districtsResult;
        
        // Store districts record ID
        if (districtsResult && districtsResult.recordId) {
          console.log('[SAVE] ✅ Districts saved. Record ID:', districtsResult.recordId);
          storeRelatedRecordIds('districts', districtsResult.recordId);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Districts submission failed:', error);
        results.errors.push({ table: 'districts', error: error.message });
      }
      
      // Submit environmental
      try {
        console.log('[SAVE] 🌳 Submitting environmental table...');
        const environmentalResult = await submitEnvironmental(applicationRecordId, formData);
        console.log('[SAVE] Environmental result:', environmentalResult);
        results.relatedRecords.environmental = environmentalResult;
        
        // Store environmental record ID
        if (environmentalResult && environmentalResult.recordId) {
          console.log('[SAVE] ✅ Environmental saved. Record ID:', environmentalResult.recordId);
          storeRelatedRecordIds('environmental', environmentalResult.recordId);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Environmental submission failed:', error);
        results.errors.push({ table: 'environmental', error: error.message });
      }
      
      // Submit permits
      try {
        console.log('[SAVE] 📋 Submitting permits table...');
        const permitsResult = await submitPermits(applicationRecordId, formData);
        console.log('[SAVE] Permits result:', permitsResult);
        results.relatedRecords.permits = permitsResult;
        
        // Store permit record IDs
        if (permitsResult && Array.isArray(permitsResult)) {
          const permitIds = permitsResult.map(function(r) { return r.recordId; });
          console.log('[SAVE] ✅ Permits saved. Record IDs:', permitIds);
          storeRelatedRecordIds('permits', permitIds);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Permits submission failed:', error);
        results.errors.push({ table: 'permits', error: error.message });
      }
      
      // Submit timeline
      try {
        console.log('[SAVE] ⏱️ Submitting timeline table...');
        const timelineResult = await submitTimeline(applicationRecordId, formData);
        console.log('[SAVE] Timeline result:', timelineResult);
        results.relatedRecords.timeline = timelineResult;
        
        // Store timeline record ID
        if (timelineResult && timelineResult.recordId) {
          console.log('[SAVE] ✅ Timeline saved. Record ID:', timelineResult.recordId);
          storeRelatedRecordIds('timeline', timelineResult.recordId);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Timeline submission failed:', error);
        results.errors.push({ table: 'timeline', error: error.message });
      }
      
      // Submit budget
      try {
        console.log('[SAVE] 💰 Submitting budget table...');
        const budgetResult = await submitBudget(applicationRecordId, formData);
        console.log('[SAVE] Budget result:', budgetResult);
        results.relatedRecords.budget = budgetResult;
        
        // Budget IDs are now stored by category name inside submitBudget() function
        // No need to store them here - submitBudget() handles it
        if (budgetResult && Array.isArray(budgetResult)) {
          console.log('[SAVE] ✅ Budget saved. Record count:', budgetResult.length);
        }
      } catch (error) {
        console.error('[SAVE] ❌ Budget submission failed:', error);
        results.errors.push({ table: 'budget', error: error.message });
      }
      
      // STEP 5: Mark as successful
      results.success = true;
      console.log('[SAVE] === Application Submission Complete ===');
      console.log('[SAVE] ✅ Successfully saved tables:', Object.keys(results.relatedRecords).length);
      console.log('[SAVE] ❌ Errors encountered:', results.errors.length);
      if (results.errors.length > 0) {
        console.log('[SAVE] Error details:', results.errors);
      }
      console.log('[SAVE] All related record IDs stored in localStorage');
      console.log('[SAVE] Final results summary:', {
        success: results.success,
        mainAppId: results.applicationRecordId,
        childTables: Object.keys(results.relatedRecords),
        errorCount: results.errors.length
      });
      
      return results;
      
    } catch (error) {
      console.error('Fatal error in submitCompleteApplication:', error);
      results.errors.push({ table: 'main', error: error.message });
      throw error;
    }
  }
  
  // Get all form fields with mq- prefix
  const getAllFields = function() {
    const fields = {};
    const inputs = document.querySelectorAll('[id^="mq_"]');
    inputs.forEach(function(input) {
      if (input.id && input.id.startsWith('mq_')) {
        const name = input.id;
        
        // Skip read-only system fields
        if (name === 'mq_record_id') {
          return;
        }
        
        if (input.type === 'checkbox') {
          // Handle checkbox arrays (name ends with [])
          if (input.name && input.name.endsWith('[]')) {
            // Keep the [] suffix in the field name
            const groupName = input.name;
            if (!fields[groupName]) {
              fields[groupName] = [];
            }
            if (input.checked) {
              fields[groupName].push(input.value);
            }
          } else {
            fields[name] = input.checked;
          }
        } else if (input.type === 'radio') {
          // Only save if checked
          if (input.checked) {
            fields[name] = input.value;
          }
        } else if (input.tagName === 'SELECT' && input.multiple) {
          // Handle multi-select dropdowns
          const selectedValues = [];
          for (let i = 0; i < input.options.length; i++) {
            if (input.options[i].selected) {
              selectedValues.push(input.options[i].value);
            }
          }
          // Use the name attribute for multi-selects (which ends with [])
          const fieldName = input.name && input.name.endsWith('[]') ? input.name : name;
          fields[fieldName] = selectedValues;
        } else {
          fields[name] = input.value || '';
        }
      }
    });
    // Also get radio button groups by name
    const radioGroups = document.querySelectorAll('input[type="radio"][name^="mq_"]');
    const radioGroupNames = {};
    radioGroups.forEach(function(radio) {
      if (radio.checked) {
        radioGroupNames[radio.name] = radio.value;
      }
    });
    Object.keys(radioGroupNames).forEach(function(name) {
      fields[name] = radioGroupNames[name];
    });
    
    // Add additional portal users
    const portalUsers = getPortalUsers();
    if (portalUsers.length > 0) {
      fields['mq_additional_portal_users'] = portalUsers;
    }
    
    return fields;
  };
  
  // Save to localStorage
  const saveDraft = function() {
    try {
      const fields = getAllFields();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fields));
    } catch (e) {
      console.error('Error saving draft:', e);
    }
  };
  
  // Make saveDraft globally accessible for map script
  window.saveDraft = saveDraft;
  
  // Diagnostic function to check token status (for debugging)
  window.checkTokenStatus = function() {
    console.log('=== Token Diagnostic ===');
    const encrypted = localStorage.getItem('token');
    if (!encrypted) {
      console.error('❌ No token found in localStorage');
      console.log('Available localStorage keys:', Object.keys(localStorage));
      return;
    }
    console.log('✅ Token found in localStorage');
    console.log('Token length:', encrypted.length);
    console.log('Token (first 50 chars):', encrypted.substring(0, 50) + '...');
    console.log('AES Key configured:', API_CONFIG.aesKey ? 'Yes' : 'No');
    console.log('AES Key (first 20 chars):', API_CONFIG.aesKey ? API_CONFIG.aesKey.substring(0, 20) + '...' : 'Not set');
    console.log('CryptoJS loaded:', typeof CryptoJS !== 'undefined' ? 'Yes' : 'No');
    console.log('\nTo test decryption, the token must be encrypted with the same AES key.');
    console.log('If decryption fails, verify with your OpenGov administrator that the AES key is correct.');
  };
  
  // Load from localStorage
  const loadDraft = function() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const fields = JSON.parse(saved);
        Object.keys(fields).forEach(function(key) {
          // Skip read-only system fields that should not be modified by draft loading
          if (key === 'mq_record_id') {
            return; // Don't overwrite the record ID field
          }
          
          // Handle radio button groups by name
          const radios = document.querySelectorAll('input[type="radio"][name="' + key + '"]');
          if (radios.length > 0) {
            radios.forEach(function(radio) {
              if (radio.value === fields[key]) {
                radio.checked = true;
              }
            });
          } else {
            // Handle checkbox arrays (name ends with [])
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="' + key + '[]"]');
            if (checkboxes.length > 0 && Array.isArray(fields[key])) {
              checkboxes.forEach(function(checkbox) {
                checkbox.checked = fields[key].includes(checkbox.value);
              });
            } else {
              // Handle regular inputs by ID
              const input = document.getElementById(key);
              if (input) {
                if (input.type === 'checkbox') {
                  input.checked = fields[key];
                } else if (input.tagName === 'SELECT' && input.multiple && Array.isArray(fields[key])) {
                  // Handle multi-select dropdowns
                  for (let i = 0; i < input.options.length; i++) {
                    input.options[i].selected = fields[key].includes(input.options[i].value);
                  }
                } else if (input.type !== 'radio') {
                  input.value = fields[key] || '';
                }
              }
            }
          }
        });
        // Update environmental doc date fields visibility after loading
        updateEnvironmentalDocDates();
        // Update applicant organization other field visibility after loading
        updateApplicantOrganizationOther();
      }
    } catch (e) {
      console.error('Error loading draft:', e);
    }
  };
  
  /**
   * Helper function to query child table records using report ID
   * @param {string} reportId - The report ID to query
   * @param {string} applicationRecordId - The application record ID to filter by
   * @param {string} token - Auth token
   * @param {string} tableName - Name of the table (for logging)
   * @param {string} relationshipFieldKey - The field key for the relationship field (e.g., 'j2ezwxsa8' for contacts)
   * @returns {Promise<Array>} Array of child records
   */
  const queryChildTableByReport = async function(reportId, applicationRecordId, token, tableName, relationshipFieldKey) {
    try {
      // Skip if report ID is not configured
      if (!reportId || reportId.startsWith('YOUR_')) {
        console.log(`[MeasureQ] ${tableName} report not configured, skipping`);
        return [];
      }
      
      console.log(`[MeasureQ] Querying ${tableName} report ${reportId} for application ${applicationRecordId} using field key ${relationshipFieldKey}`);
      
      const url = `${API_CONFIG.baseURL}/api/Report/queryreport`;
      const payload = {
        ReportId: reportId,
        ConditionGroups: [
          {
            Type: 'all',
            Conditions: [
              {
                ConditionField: { Key: relationshipFieldKey },
                OperationType: 'is equal',
                Value: String(applicationRecordId)
              }
            ]
          }
        ]
      };
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      console.log(`[MeasureQ] Response status for ${tableName}:`, response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.warn(`[MeasureQ] Failed to query ${tableName}:`, response.status, errorText);
        return [];
      }
      
      const result = await response.json();
      let records = Array.isArray(result) ? result : (result.data || result.Data || []);
      
      console.log(`[MeasureQ] Retrieved ${records.length} ${tableName} records from API`);
      
      // CLIENT-SIDE FILTERING: Ensure we only use records that match this application
      // This is a safety check in case the API filter doesn't work correctly
      const filteredRecords = records.filter(function(record) {
        // Check for related_applications field (with or without table prefix)
        for (const key in record) {
          if (key === 'related_applications' || key.endsWith('_related_applications')) {
            const relatedAppId = String(record[key]);
            const matches = relatedAppId === String(applicationRecordId);
            if (!matches) {
              console.warn(`[MeasureQ] ⚠️ Filtering out ${tableName} record with mismatched related_applications:`, relatedAppId, '(expected:', applicationRecordId, ')');
            }
            return matches;
          }
        }
        // If no related_applications field found, log warning and exclude
        console.warn(`[MeasureQ] ⚠️ ${tableName} record has no related_applications field:`, Object.keys(record));
        return false;
      });
      
      console.log(`[MeasureQ] After filtering: ${filteredRecords.length} ${tableName} records match application ${applicationRecordId}`);
      
      if (filteredRecords.length > 0) {
        console.log(`[MeasureQ] First ${tableName} record fields:`, Object.keys(filteredRecords[0]).slice(0, 10));
        
        // Extra logging for Districts table
        if (tableName === 'Districts') {
          console.log(`[MeasureQ] DISTRICTS FILTERED RECORDS:`, filteredRecords);
          console.log(`[MeasureQ] DISTRICTS FIRST RECORD - ALL FIELDS:`, filteredRecords[0]);
        }
      }
      
      return filteredRecords;
    } catch (error) {
      console.error(`[MeasureQ] Error querying ${tableName}:`, error);
      return [];
    }
  };

  /**
   * Load application data from API based on stored record ID
   * This ensures users see the latest saved data when navigating between pages
   * @returns {Promise<boolean>} True if data was successfully loaded from API, false otherwise
   */
  const loadFromAPI = async function() {
    try {
      const recordId = localStorage.getItem('mq_current_application_id');
      
      if (!recordId) {
        console.log('[MeasureQ] No record ID found. Skipping API load.');
        return false;
      }
      
      console.log('[MeasureQ] Loading application from API, record ID:', recordId);
      
      const token = await getAuthToken();
      if (!token || !API_CONFIG.applicationsReportId) {
        console.log('[MeasureQ] API not configured. Falling back to localStorage.');
        return false;
      }
      
      // Query the applications report to get this specific record
      const url = `${API_CONFIG.baseURL}/api/Report/queryreport`;
      const payload = {
        ReportId: API_CONFIG.applicationsReportId,
        ConditionGroups: [
          {
            Type: 'all',
            Conditions: [
              {
                ConditionField: { Key: '8ra3bhiw1' },  // Field key for 'id' in applications report
                OperationType: 'is equal',
                Value: String(recordId)
              }
            ]
          }
        ]
      };
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        throw new Error(`API returned ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      const applications = Array.isArray(result) ? result : (result.data || result.Data || []);
      
      if (!applications || applications.length === 0) {
        console.log('[MeasureQ] No application found with ID:', recordId);
        return false;
      }
      
      // Helper function to extract field value from API data
      const extractFieldValue = function(data, fieldName) {
        // Try exact match first
        if (data[fieldName] !== undefined) return data[fieldName];
        
        // Try with table prefix (e.g., tbl97fiqdua5_project_type)
        // Use endsWith to ensure we match the exact field name, not partial matches
        for (const key in data) {
          if (key.endsWith('_' + fieldName)) {
            return data[key];
          }
        }
        
        return null;
      };
      
      const appData = applications[0];
      console.log('[MeasureQ] ✅ Found application in API');
      console.log('[MeasureQ] 📋 Application ID:', appData.id || appData.tbl97fiqdua5_id || appData.Rid);
      console.log('[MeasureQ] Sample fields:', Object.keys(appData).slice(0, 10));
      
      // Check if this is a NEW/empty shell record (just created)
      const projectTitle = extractFieldValue(appData, 'project_title');
      const isEmptyShell = !projectTitle || projectTitle.trim() === '';
      
      if (isEmptyShell) {
        console.log('[MeasureQ] 🆕 This is a NEW/empty application - no data to load yet');
        return false; // Don't populate form fields for empty shell records
      }
      
      console.log('[MeasureQ] 📄 Loading existing application data...');
      
      // Extract vendor name directly from report (tbl12512_vendor_name or vendor_name)
      const vendorNameToSet = extractFieldValue(appData, 'vendor_name') || extractFieldValue(appData, 'tbl12512_vendor_name') || null;
      if (vendorNameToSet) {
        console.log('[MeasureQ] Storing vendor name for later:', vendorNameToSet);
      }
      
      // Map API fields back to form fields
      Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
        const mapping = FIELD_MAPPING[formFieldId];
        const value = extractFieldValue(appData, mapping.name);
        
        // Skip applicant organization here - we'll handle it after loading vendors
        if (formFieldId === 'mq_applicant_organization') {
          return;
        }
        
        if (value !== null && value !== undefined && value !== '') {
          const field = document.getElementById(formFieldId);
          
          if (field) {
            console.log('[MeasureQ] Setting field:', formFieldId, '=', value);
            
            if (field.type === 'checkbox') {
              field.checked = (value === 'true' || value === true || value === '1' || value === 1);
            } else if (field.tagName === 'SELECT' && field.multiple) {
              // Handle multi-select
              const values = Array.isArray(value) ? value : String(value).split(', ');
              for (let i = 0; i < field.options.length; i++) {
                field.options[i].selected = values.includes(field.options[i].value);
              }
            } else if (field.tagName === 'TEXTAREA') {
              field.value = value;
              // Trigger word count update if applicable
              field.dispatchEvent(new Event('input'));
            } else {
              field.value = value;
            }
          }
        }
      });
      
      // Handle radio buttons (environmental documentation, etc.)
      Object.keys(appData).forEach(function(apiKey) {
        const value = appData[apiKey];
        if (value) {
          // Look for radio buttons that might match this field
          const cleanKey = apiKey.replace(/^tbl[^_]+_/, ''); // Remove table prefix
          const radios = document.querySelectorAll('input[type="radio"][name*="' + cleanKey + '"]');
          if (radios.length > 0) {
            radios.forEach(function(radio) {
              if (radio.value === value) {
                radio.checked = true;
                console.log('[MeasureQ] Setting radio:', radio.name, '=', value);
              }
            });
          }
        }
      });
      
      // Handle checkbox arrays (jurisdictions, etc.)
      Object.keys(appData).forEach(function(apiKey) {
        const value = appData[apiKey];
        if (value) {
          const cleanKey = apiKey.replace(/^tbl[^_]+_/, ''); // Remove table prefix
          const checkboxes = document.querySelectorAll('input[type="checkbox"][name*="' + cleanKey + '"]');
          if (checkboxes.length > 0) {
            const values = Array.isArray(value) ? value : String(value).split(', ');
            checkboxes.forEach(function(checkbox) {
              if (values.includes(checkbox.value)) {
                checkbox.checked = true;
                console.log('[MeasureQ] Setting checkbox:', checkbox.name, '=', checkbox.value);
              }
            });
          }
        }
      });
      
      // =================================================================
      // STEP 2: Load data from child tables
      // =================================================================
      console.log('[MeasureQ] Loading child table data...');
      
      // Load Contacts data
      const contactsData = await queryChildTableByReport(API_CONFIG.contactsReportId, recordId, token, 'Contacts', API_CONFIG.contactsRelationshipFieldKey);
      if (contactsData && contactsData.length > 0) {
        console.log('[MeasureQ] Loaded contacts data:', contactsData.length, 'records');
        
        // Find the primary contact specifically (by is_primary field or contact_type)
        let primaryContact = null;
        for (const contact of contactsData) {
          const isPrimary = extractFieldValue(contact, 'is_primary');
          const contactType = extractFieldValue(contact, 'contact_type');
          
          if (isPrimary === 'true' || isPrimary === true || contactType === 'Primary Contact') {
            primaryContact = contact;
            console.log('[MeasureQ] Found primary contact:', contact);
            break;
          }
        }
        
        // Fallback to first contact if no primary found
        if (!primaryContact && contactsData.length > 0) {
          console.warn('[MeasureQ] No primary contact found, using first contact');
          primaryContact = contactsData[0];
        }
        
        const contact = primaryContact;
        
        // Store the primary contact's record ID for future updates
        const contactRid = contact.Rid || extractFieldValue(contact, 'id') || extractFieldValue(contact, 'record_id');
        if (contactRid) {
          console.log('[MeasureQ] Storing primary contact record ID:', contactRid);
          storeRelatedRecordIds('contacts', contactRid);
        }
        
        // Handle primary contact name - combine first_name and last_name
        const firstName = extractFieldValue(contact, 'first_name') || '';
        const lastName = extractFieldValue(contact, 'last_name') || '';
        const fullName = (firstName + ' ' + lastName).trim();
        if (fullName) {
          const nameField = document.getElementById('mq_primary_contact_name');
          if (nameField) {
            nameField.value = fullName;
            console.log('[MeasureQ] Set contacts field: mq_primary_contact_name =', fullName);
          }
        }
        
        // Handle other contact fields
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'contacts' && formFieldId !== 'mq_primary_contact_name') {
            const value = extractFieldValue(contact, mapping.name);
            if (value !== null && value !== undefined && value !== '') {
              const field = document.getElementById(formFieldId);
              if (field) {
                field.value = value;
                console.log('[MeasureQ] Set contacts field:', formFieldId, '=', value);
              }
            }
          }
        });
        
        // Load additional portal users from contacts table
        const portalUsers = [];
        const portalUserIds = [];
        
        for (const contact of contactsData) {
          const contactType = extractFieldValue(contact, 'contact_type');
          const isPrimary = extractFieldValue(contact, 'is_primary');
          
          // Skip primary contact - we already handled it
          if (isPrimary === 'true' || isPrimary === true || contactType === 'Primary Contact') {
            continue;
          }
          
          // Add portal users (non-primary contacts with portal access)
          const hasPortalAccess = extractFieldValue(contact, 'has_portal_access');
          if (contactType === 'Portal User' || hasPortalAccess === 'true' || hasPortalAccess === true) {
            const firstName = extractFieldValue(contact, 'first_name') || '';
            const lastName = extractFieldValue(contact, 'last_name') || '';
            const email = extractFieldValue(contact, 'email') || '';
            
            if (email) {  // Must have email
              portalUsers.push({
                firstName: firstName,
                lastName: lastName,
                email: email
              });
              
              const rid = contact.Rid || extractFieldValue(contact, 'id') || extractFieldValue(contact, 'record_id');
              if (rid) {
                portalUserIds.push(rid);
              }
            }
          }
        }
        
        if (portalUsers.length > 0) {
          console.log('[MeasureQ] Loaded', portalUsers.length, 'portal users from database:', portalUsers);
          savePortalUsers(portalUsers);
          renderPortalUsersTable();
          
          // Store portal user record IDs for updates (append to contacts IDs array)
          if (portalUserIds.length > 0) {
            console.log('[MeasureQ] Storing portal user record IDs:', portalUserIds);
            const existingIds = getRelatedRecordIds('contacts') || [];
            const allContactIds = existingIds.concat(portalUserIds);
            storeRelatedRecordIds('contacts', allContactIds);
          }
        }
      } else {
        // No contacts found in API - clear primary contact fields to avoid showing stale local data
        console.log('[MeasureQ] No contacts found in API - clearing primary contact fields');
        
        // Clear all contact-related form fields
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'contacts') {
            const field = document.getElementById(formFieldId);
            if (field) {
              field.value = '';
              console.log('[MeasureQ] Cleared contacts field:', formFieldId);
            }
          }
        });
        
        // Clear portal users table
        savePortalUsers([]);
        renderPortalUsersTable();
        
        // Clear stored contact record IDs
        storeRelatedRecordIds('contacts', []);
      }
      
      // Load Locations data
      const locationsData = await queryChildTableByReport(API_CONFIG.locationsReportId, recordId, token, 'Locations', API_CONFIG.locationsRelationshipFieldKey);
      if (locationsData && locationsData.length > 0) {
        console.log('[MeasureQ] Loaded locations data:', locationsData.length, 'records');
        const location = locationsData[0];
        
        // Store the locations record ID for future updates
        const locationRid = location.Rid || extractFieldValue(location, 'id') || extractFieldValue(location, 'record_id');
        if (locationRid) {
          console.log('[MeasureQ] Storing locations record ID:', locationRid);
          storeRelatedRecordIds('locations', locationRid);
        }
        
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'locations') {
            const value = extractFieldValue(location, mapping.name);
            if (value !== null && value !== undefined && value !== '') {
              const field = document.getElementById(formFieldId);
              if (field) {
                field.value = value;
                console.log('[MeasureQ] Set locations field:', formFieldId, '=', value);
              }
            }
          }
        });
      }
      
      // Load Districts & Representation data
      const districtsData = await queryChildTableByReport(API_CONFIG.districtsReportId, recordId, token, 'Districts', API_CONFIG.districtsRelationshipFieldKey);
      console.log('[MeasureQ] Districts data result:', districtsData);
      
      if (districtsData && districtsData.length > 0) {
        console.log('[MeasureQ] Loaded districts data:', districtsData.length, 'records');
        
        // WARNING: Multiple districts records found - this shouldn't happen in 1-to-1 relationship
        if (districtsData.length > 1) {
          console.warn('[MeasureQ] ⚠️ Multiple districts records found for application:', recordId);
          console.warn('[MeasureQ] This indicates duplicate data or filtering issue. Using first record only.');
          console.log('[MeasureQ] All districts records:', districtsData);
        }
        
        // Use the FIRST record (should be only one after proper filtering)
        const district = districtsData[0];
        console.log('[MeasureQ] Using districts record at index: 0');
        console.log('[MeasureQ] District record fields:', Object.keys(district));
        console.log('[MeasureQ] Full district record data:', district);
        console.log('[MeasureQ] Fields containing "jurisdiction":', Object.keys(district).filter(k => k.toLowerCase().includes('jurisd')));
        console.log('[MeasureQ] Fields containing "supervisor":', Object.keys(district).filter(k => k.toLowerCase().includes('super')));
        
        // Store the districts record ID for future updates
        const districtRid = district.Rid || extractFieldValue(district, 'id') || extractFieldValue(district, 'record_id');
        if (districtRid) {
          console.log('[MeasureQ] Storing districts record ID:', districtRid);
          storeRelatedRecordIds('districts', districtRid);
        } else {
          console.warn('[MeasureQ] ⚠️ Could not find districts record ID in loaded data');
        }
        
        // Populate districts fields from the selected record
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'districts') {
            const value = extractFieldValue(district, mapping.name);
            console.log('[MeasureQ] Districts field lookup:', formFieldId, 'mapping name:', mapping.name, 'value:', value);
            
            if (value !== null && value !== undefined && value !== '') {
              const field = document.getElementById(formFieldId);
              if (field) {
                if (field.tagName === 'SELECT') {
                  field.value = value;
                } else if (field.tagName === 'TEXTAREA') {
                  field.value = value;
                  field.dispatchEvent(new Event('input'));
                } else {
                  field.value = value;
                }
                console.log('[MeasureQ] Set districts field:', formFieldId, '=', value);
              } else {
                console.warn('[MeasureQ] Field not found:', formFieldId);
              }
            }
          }
        });
        
        // Handle project jurisdiction checkboxes
        // Try multiple possible field names
        console.log('[MeasureQ] Attempting to extract project_jurisdiction...');
        const jurisdictions1 = extractFieldValue(district, 'project_jurisdiction');
        console.log('[MeasureQ] extractFieldValue(district, "project_jurisdiction"):', jurisdictions1);
        
        const jurisdictions2 = extractFieldValue(district, 'mq_project_jurisdiction');
        console.log('[MeasureQ] extractFieldValue(district, "mq_project_jurisdiction"):', jurisdictions2);
        
        const jurisdictions3 = extractFieldValue(district, 'jurisdiction');
        console.log('[MeasureQ] extractFieldValue(district, "jurisdiction"):', jurisdictions3);
        
        let jurisdictions = jurisdictions1 || jurisdictions2 || jurisdictions3;
        
        console.log('[MeasureQ] Final jurisdiction value from API:', jurisdictions);
        console.log('[MeasureQ] Looking for jurisdiction in all district keys:', Object.keys(district).filter(k => k.toLowerCase().includes('jurisd')));
        
        // Also log the actual values in the district object
        Object.keys(district).filter(k => k.toLowerCase().includes('jurisd')).forEach(function(key) {
          console.log('[MeasureQ] Value in', key, ':', district[key]);
        });
        
        if (jurisdictions) {
          const values = Array.isArray(jurisdictions) ? jurisdictions : String(jurisdictions).split(', ');
          console.log('[MeasureQ] Jurisdiction values to check:', values);
          const checkboxes = document.querySelectorAll('input[name="mq_project_jurisdiction[]"]');
          checkboxes.forEach(function(checkbox) {
            console.log('[MeasureQ] Comparing checkbox value:', checkbox.value, 'against:', values);
            if (values.includes(checkbox.value)) {
              checkbox.checked = true;
              console.log('[MeasureQ] ✓ Set jurisdiction checkbox:', checkbox.value);
            }
          });
        } else {
          console.warn('[MeasureQ] No jurisdiction data found in district record');
        }
        
        // Handle county supervisor district checkboxes
        // Try multiple possible field names
        console.log('[MeasureQ] Attempting to extract county_supervisor_district...');
        const supervisorDistricts1 = extractFieldValue(district, 'county_supervisor_district');
        console.log('[MeasureQ] extractFieldValue(district, "county_supervisor_district"):', supervisorDistricts1);
        
        const supervisorDistricts2 = extractFieldValue(district, 'mq_county_supervisor_district');
        console.log('[MeasureQ] extractFieldValue(district, "mq_county_supervisor_district"):', supervisorDistricts2);
        
        const supervisorDistricts3 = extractFieldValue(district, 'supervisor_district');
        console.log('[MeasureQ] extractFieldValue(district, "supervisor_district"):', supervisorDistricts3);
        
        let supervisorDistricts = supervisorDistricts1 || supervisorDistricts2 || supervisorDistricts3;
        
        console.log('[MeasureQ] Final supervisor district value from API:', supervisorDistricts);
        console.log('[MeasureQ] Looking for supervisor in all district keys:', Object.keys(district).filter(k => k.toLowerCase().includes('super')));
        
        // Also log the actual values in the district object
        Object.keys(district).filter(k => k.toLowerCase().includes('super')).forEach(function(key) {
          console.log('[MeasureQ] Value in', key, ':', district[key]);
        });
        
        if (supervisorDistricts) {
          const values = Array.isArray(supervisorDistricts) ? supervisorDistricts : String(supervisorDistricts).split(', ');
          console.log('[MeasureQ] Supervisor district values to check:', values);
          const checkboxes = document.querySelectorAll('input[name="mq_county_supervisor_district[]"]');
          checkboxes.forEach(function(checkbox) {
            console.log('[MeasureQ] Comparing checkbox value:', checkbox.value, 'against:', values);
            if (values.includes(checkbox.value)) {
              checkbox.checked = true;
              console.log('[MeasureQ] ✓ Set supervisor district checkbox:', checkbox.value);
            }
          });
        } else {
          console.warn('[MeasureQ] No supervisor district data found in district record');
        }
      }
      
      // Load Environmental Compliance data
      const environmentalData = await queryChildTableByReport(API_CONFIG.environmentalReportId, recordId, token, 'Environmental', API_CONFIG.environmentalRelationshipFieldKey);
      if (environmentalData && environmentalData.length > 0) {
        console.log('[MeasureQ] Loaded environmental data:', environmentalData.length, 'records');
        const env = environmentalData[0];
        
        // Store the environmental record ID for future updates
        const envRid = env.Rid || extractFieldValue(env, 'id') || extractFieldValue(env, 'record_id');
        if (envRid) {
          console.log('[MeasureQ] Storing environmental record ID:', envRid);
          storeRelatedRecordIds('environmental', envRid);
        }
        
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'environmental') {
            const value = extractFieldValue(env, mapping.name);
            if (value !== null && value !== undefined && value !== '') {
              const field = document.getElementById(formFieldId);
              if (field) {
                if (field.type === 'date') {
                  field.value = value;
                } else if (field.tagName === 'TEXTAREA') {
                  field.value = value;
                  field.dispatchEvent(new Event('input'));
                } else {
                  field.value = value;
                }
                console.log('[MeasureQ] Set environmental field:', formFieldId, '=', value);
              }
            }
          }
        });
        
        // Handle environmental documentation radio button
        const envDocStatus = extractFieldValue(env, 'env_doc_status');
        if (envDocStatus) {
          const radios = document.querySelectorAll('input[name="mq_env_doc_status"]');
          radios.forEach(function(radio) {
            if (radio.value === envDocStatus) {
              radio.checked = true;
              console.log('[MeasureQ] Set environmental radio:', envDocStatus);
            }
          });
        }
      }
      
      // Load Timeline data
      const timelineData = await queryChildTableByReport(API_CONFIG.timelineReportId, recordId, token, 'Timeline', API_CONFIG.timelineRelationshipFieldKey);
      if (timelineData && timelineData.length > 0) {
        console.log('[MeasureQ] Loaded timeline data:', timelineData.length, 'records');
        const timeline = timelineData[0];
        
        // Store the timeline record ID for future updates
        const timelineRid = timeline.Rid || extractFieldValue(timeline, 'id') || extractFieldValue(timeline, 'record_id');
        if (timelineRid) {
          console.log('[MeasureQ] Storing timeline record ID:', timelineRid);
          storeRelatedRecordIds('timeline', timelineRid);
        }
        
        Object.keys(FIELD_MAPPING).forEach(function(formFieldId) {
          const mapping = FIELD_MAPPING[formFieldId];
          if (mapping.table === 'timeline') {
            const value = extractFieldValue(timeline, mapping.name);
            if (value !== null && value !== undefined && value !== '') {
              const field = document.getElementById(formFieldId);
              if (field) {
                if (field.type === 'number' || field.tagName === 'SELECT') {
                  field.value = value;
                } else if (field.tagName === 'TEXTAREA') {
                  field.value = value;
                  field.dispatchEvent(new Event('input'));
                } else {
                  field.value = value;
                }
                console.log('[MeasureQ] Set timeline field:', formFieldId, '=', value);
              }
            }
          }
        });
      }
      
      // Load Permits data
      const permitsData = await queryChildTableByReport(API_CONFIG.permitsReportId, recordId, token, 'Permits', API_CONFIG.permitsRelationshipFieldKey);
      if (permitsData && permitsData.length > 0) {
        console.log('[MeasureQ] Loaded permits data:', permitsData.length, 'records');
        console.log('[MeasureQ] First Permits record fields:', permitsData[0]);
        
        // Group permits by agency and take the last (most recent) record for each
        const permitsByAgency = {};
        permitsData.forEach(function(permit) {
          const agencyName = extractFieldValue(permit, 'permit_agency') || extractFieldValue(permit, 'agency_name') || extractFieldValue(permit, 'agency');
          if (agencyName) {
            // Overwrite with each record - last one wins (most recent)
            permitsByAgency[agencyName] = permit;
          }
        });
        
        console.log('[MeasureQ] Unique agencies found:', Object.keys(permitsByAgency).length);
        
        // Populate static permits fields (radio buttons, comments, status)
        // Map agency names from data to form field prefixes
        const permitFieldMapping = {
          'California Fish and Wildlife': 'mq_perm_ca_fish_wildlife',
          'State Water Control Resources Board': 'mq_perm_state_water',
          'US Fish and Wildlife': 'mq_perm_us_fish_wildlife',
          'City/County Construction Permits': 'mq_perm_city_county',
          'Coastal Commission': 'mq_perm_coastal',
          'Other': 'mq_perm_other'
        };
        
        Object.keys(permitsByAgency).forEach(function(agencyName) {
          const permit = permitsByAgency[agencyName];
          const response = extractFieldValue(permit, 'permit_required') || extractFieldValue(permit, 'response') || extractFieldValue(permit, 'permit_response');
          const comment = extractFieldValue(permit, 'permit_comment') || extractFieldValue(permit, 'comment') || extractFieldValue(permit, 'comments');
          const status = extractFieldValue(permit, 'permit_status') || extractFieldValue(permit, 'status');
          
          console.log('[MeasureQ] Processing permit:', { agencyName, response, comment, status });
          
          const formPrefix = permitFieldMapping[agencyName];
          if (formPrefix) {
            // Set radio button
            if (response) {
              const radioId = formPrefix + '_' + response.toLowerCase().replace(/\s+/g, '');
              const radio = document.getElementById(radioId);
              if (radio) {
                radio.checked = true;
                console.log('[MeasureQ] Set permit radio:', radioId);
              }
            }
            
            // Set comment
            if (comment) {
              const commentField = document.getElementById(formPrefix + '_comment');
              if (commentField) {
                commentField.value = comment;
                console.log('[MeasureQ] Set permit comment:', formPrefix);
              }
            }
            
            // Set status
            if (status) {
              const statusField = document.getElementById(formPrefix + '_status');
              if (statusField) {
                statusField.value = status;
                console.log('[MeasureQ] Set permit status:', formPrefix);
              }
            }
          }
        });
      }
      
      // Load Budget data
      const budgetData = await queryChildTableByReport(API_CONFIG.budgetReportId, recordId, token, 'Budget', API_CONFIG.budgetRelationshipFieldKey);
      if (budgetData && budgetData.length > 0) {
        console.log('[MeasureQ] Loaded budget data:', budgetData.length, 'records');
        console.log('[MeasureQ] First Budget record fields:', budgetData[0]);
        
        // Map budget category names from data to form field prefixes
        const budgetCategoryMapping = {
          'Personnel': 'personnel',
          'Fringe Benefits': 'fringe',
          'Travel': 'travel',
          'Equipment': 'equipment',
          'Supplies': 'supplies',
          'Contractual / Consultants': 'contractual',
          'Contractual': 'contractual',
          'Consultants': 'contractual',
          'Construction': 'construction',
          'Other Direct Costs': 'other_direct',
          'Indirect Costs': 'indirect'
        };
        
        // Store budget IDs by category name (not by index)
        const budgetIdsByCategory = {};
        
        budgetData.forEach(function(budget) {
          const category = extractFieldValue(budget, 'category') || extractFieldValue(budget, 'budget_category');
          const measureq = extractFieldValue(budget, 'measureq_funds') || extractFieldValue(budget, 'measure_q_requested');
          const match = extractFieldValue(budget, 'match_cash') || extractFieldValue(budget, 'match_funds') || extractFieldValue(budget, 'match');
          const inkind = extractFieldValue(budget, 'inkind_funds') || extractFieldValue(budget, 'in_kind');
          
          // Extract record ID for this budget item
          const budgetRid = budget.Rid || extractFieldValue(budget, 'id') || extractFieldValue(budget, 'record_id');
          if (budgetRid && category) {
            budgetIdsByCategory[category] = budgetRid;
            console.log('[MeasureQ] Storing budget ID for category:', category, '=', budgetRid);
          }
          
          console.log('[MeasureQ] Processing budget:', { category, measureq, match, inkind, rid: budgetRid });
          
          const fieldSuffix = budgetCategoryMapping[category];
          if (fieldSuffix) {
            // Set MeasureQ funds
            if (measureq !== null && measureq !== undefined) {
              const mqField = document.getElementById('mq_budget_' + fieldSuffix + '_measureq');
              if (mqField) {
                mqField.value = measureq;
                console.log('[MeasureQ] Set budget measureq:', fieldSuffix, '=', measureq);
              }
            }
            
            // Set Match funds
            if (match !== null && match !== undefined) {
              const matchField = document.getElementById('mq_budget_' + fieldSuffix + '_match');
              if (matchField) {
                matchField.value = match;
                console.log('[MeasureQ] Set budget match:', fieldSuffix, '=', match);
              }
            }
            
            // Set In-Kind funds
            if (inkind !== null && inkind !== undefined) {
              const inkindField = document.getElementById('mq_budget_' + fieldSuffix + '_inkind');
              if (inkindField) {
                inkindField.value = inkind;
                console.log('[MeasureQ] Set budget inkind:', fieldSuffix, '=', inkind);
              }
            }
            
            // Calculate total for this row
            calculateBudgetRowTotal(fieldSuffix);
          }
        });
        
        // Store budget IDs by category name
        if (Object.keys(budgetIdsByCategory).length > 0) {
          storeRelatedRecordIds('budget', budgetIdsByCategory);
          console.log('[MeasureQ] ✅ Stored budget IDs by category:', budgetIdsByCategory);
        }
        
        // Recalculate all budget totals
        calculateAllBudgetTotals();
      }
      
      // Load vendors into dropdown and set the value if we have one
      if (vendorNameToSet) {
        console.log('[MeasureQ] Loading vendors to populate organization dropdown...');
        await loadApplicantOrganizationOptionsFromApi();
        
        const orgDropdown = document.getElementById('mq_applicant_organization');
        if (orgDropdown) {
          // Find the dropdown option that matches the vendor name
          const options = orgDropdown.querySelectorAll('option');
          let valueToSet = '';
          let found = false;
          
          for (const option of options) {
            if (option.textContent.trim() === vendorNameToSet.trim()) {
              valueToSet = option.value;
              found = true;
              console.log('[MeasureQ] Found matching vendor by name:', vendorNameToSet, '-> Rid:', valueToSet);
              break;
            }
          }
          
          if (!found) {
            console.warn('[MeasureQ] Could not find vendor with name:', vendorNameToSet);
            valueToSet = ''; // Reset to empty - user must select
          }
          
          orgDropdown.value = valueToSet;
          console.log('[MeasureQ] Set applicant organization to:', valueToSet || '(empty - please select)');
          
          // Verify the value was set correctly
          if (valueToSet && orgDropdown.value !== valueToSet) {
            console.warn('[MeasureQ] Failed to set organization dropdown - vendor not found in options');
          }
        }
      }
      
      // Check if current user is the creator - if not, make Applicant Organization read-only
      const createdBy = extractFieldValue(appData, 'createdby') || extractFieldValue(appData, 'tbl12432_createdby');
      if (createdBy) {
        try {
          const profile = await getUserProfile();
          const currentUserEmail = profile?.Email;
          
          if (currentUserEmail && createdBy) {
            console.log('[MeasureQ] Checking creator permissions - Created by:', createdBy, 'Current user:', currentUserEmail);
            
            // Compare emails (case-insensitive)
            if (createdBy.toLowerCase() !== currentUserEmail.toLowerCase()) {
              console.log('[MeasureQ] Current user is NOT the creator - making Applicant Organization read-only');
              
              const orgDropdown = document.getElementById('mq_applicant_organization');
              if (orgDropdown) {
                orgDropdown.disabled = true;
                orgDropdown.style.cursor = 'not-allowed';
                orgDropdown.style.backgroundColor = '#f1f5f9';
                
                // Update help text to explain why it's read-only
                const helpTextContainer = orgDropdown.parentElement;
                let helpText = helpTextContainer.querySelector('.mq-help');
                if (!helpText) {
                  helpText = document.createElement('p');
                  helpText.className = 'mq-help';
                  helpTextContainer.appendChild(helpText);
                }
                helpText.innerHTML = `<span style="color: #ef4444;">⚠️ Only the application creator (<strong>${escapeHtml(createdBy)}</strong>) can change the organization.</span>`;
              }
            } else {
              console.log('[MeasureQ] Current user IS the creator - allowing organization editing');
            }
          }
        } catch (error) {
          console.warn('[MeasureQ] Could not verify creator permissions:', error);
          // If we can't verify, allow editing (fail open)
        }
      }
      
      // Trigger updates for conditional fields
      updateEnvironmentalDocDates();
      updateApplicantOrganizationOther();
      updateConditionalFields();
      
      console.log('[MeasureQ] Successfully loaded application and child tables from API');
      return true;
      
    } catch (error) {
      console.error('[MeasureQ] Error loading from API:', error);
      console.log('[MeasureQ] Falling back to localStorage draft');
      return false;
    }
  };
  
  // Update environmental documentation date fields visibility
  const updateEnvironmentalDocDates = function() {
    const selected = document.querySelector('input[name="mq_env_doc_status"]:checked');
    const dateFields = [
      'mq_env_doc_initial_study_date',
      'mq_env_doc_negative_declaration_date',
      'mq_env_doc_categorically_exempt_date',
      'mq_env_doc_in_process_date',
      'mq_env_doc_completed_date'
    ];
    
    // Hide all date fields first
    dateFields.forEach(function(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.style.display = 'none';
      }
    });
    
    // Show the relevant date field based on selection
    if (selected) {
      const value = selected.value;
      let fieldId = null;
      
      if (value === 'Initial Study Completed') {
        fieldId = 'mq_env_doc_initial_study_date';
      } else if (value === 'Negative Declaration') {
        fieldId = 'mq_env_doc_negative_declaration_date';
      } else if (value === 'Categorically Exempt') {
        fieldId = 'mq_env_doc_categorically_exempt_date';
      } else if (value === 'CEQA/NEPA in process') {
        fieldId = 'mq_env_doc_in_process_date';
      } else if (value === 'CEQA/NEPA completed') {
        fieldId = 'mq_env_doc_completed_date';
      }
      
      if (fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
          field.style.display = 'inline-block';
        }
      }
    }
  };
  
  // Format and validate date input (YYYY-MM-DD format)
  const formatDateInput = function(input) {
    // Remove all non-digit characters
    let value = input.value.replace(/\D/g, '');
    
    // Limit to 8 digits (YYYYMMDD)
    if (value.length > 8) {
      value = value.substring(0, 8);
    }
    
    // Format as YYYY-MM-DD
    let formatted = '';
    if (value.length > 0) {
      formatted = value.substring(0, 4); // YYYY
      if (value.length > 4) {
        formatted += '-' + value.substring(4, 6); // MM
        if (value.length > 6) {
          formatted += '-' + value.substring(6, 8); // DD
        }
      }
    }
    
    input.value = formatted;
  };
  
  // Validate date format (YYYY-MM-DD)
  const validateDateFormat = function(dateString) {
    if (!dateString) return true; // Empty is valid (optional field)
    
    // Check format: YYYY-MM-DD
    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
    if (!datePattern.test(dateString)) {
      return false;
    }
    
    // Validate actual date values
    const parts = dateString.split('-');
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const day = parseInt(parts[2], 10);
    
    // Basic range validation
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    if (year < 1900 || year > 2100) return false;
    
    // Check if date is valid (e.g., not Feb 30)
    const date = new Date(year, month - 1, day);
    if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
      return false;
    }
    
    return true;
  };
  
  // Update DAC/SDAC fields visibility based on selection
  const updateDacSdacFields = function() {
    const isDacSdacField = document.getElementById('mq_is_dac_sdac');
    const dacSdacContainer = document.getElementById('mq_dac_sdac_fields_container');
    
    if (!isDacSdacField || !dacSdacContainer) return;
    
    const selectedValue = isDacSdacField.value;
    
    if (selectedValue === 'Yes') {
      // Show DAC/SDAC fields
      dacSdacContainer.style.display = 'contents';
    } else {
      // Hide DAC/SDAC fields
      dacSdacContainer.style.display = 'none';
    }
  };
  
  // Update status section based on project type
  const updateStatusSection = function() {
    const projectTypeField = document.getElementById('mq_project_type');
    const tierStep = document.getElementById('mq_status_step_tier');
    const tierLabel = document.getElementById('mq_status_tier_label');
    const lineFill = document.getElementById('mq_status_line_fill');
    
    if (!projectTypeField || !tierStep || !tierLabel || !lineFill) return;
    
    const projectType = projectTypeField.value;
    
    // Update progress line (50% when project type selected, 0% when not)
    if (projectType) {
      lineFill.style.width = '50%';
    } else {
      lineFill.style.width = '0%';
    }
    
    // Update tier step label and active state
    if (projectType === 'Tier 1 Community Catalyst Grant') {
      tierLabel.innerHTML = 'Tier 1<br><small>Application</small>';
      tierStep.classList.remove('active');
    } else if (
      projectType === 'Tier 2 Community Impact Grants' ||
      projectType === 'Tier 2 Pajaro Valley Set-Aside' ||
      projectType === 'Tier 2 San Vicente Redwoods Set-Aside'
    ) {
      tierLabel.innerHTML = 'Tier 2<br><small>Application</small>';
      tierStep.classList.remove('active');
    } else {
      tierLabel.innerHTML = 'Application<br><small>Section</small>';
      tierStep.classList.remove('active');
    }
  };
  
  // Update conditional visibility
  // Make it globally accessible for use in autocomplete handler
  const updateConditionalFields = function() {
    const jurisdictionCheckboxes = document.querySelectorAll('input[name="mq_project_jurisdiction[]"]');
    const otherCityWrap = document.getElementById('mq_other_city_council_area_notes_wrap');
    const jurisdictionCommunitiesWrap = document.getElementById('mq_jurisdiction_communities_wrap');
    
    if (!jurisdictionCheckboxes || jurisdictionCheckboxes.length === 0 || !otherCityWrap) return;
    
    // Check if any jurisdiction is selected
    const anyChecked = Array.from(jurisdictionCheckboxes).some(checkbox => checkbox.checked);
    
    if (anyChecked) {
      otherCityWrap.classList.remove('mq-hidden');
    } else {
      otherCityWrap.classList.add('mq-hidden');
    }
    
    // Show communities description field if Unincorporated or Multiple jurisdictions is selected
    if (jurisdictionCommunitiesWrap) {
      const unincorporatedCheckbox = document.getElementById('mq_project_jurisdiction_unincorporated');
      const multipleCheckbox = document.getElementById('mq_project_jurisdiction_multiple');
      
      const shouldShowCommunities = (unincorporatedCheckbox && unincorporatedCheckbox.checked) ||
                                     (multipleCheckbox && multipleCheckbox.checked);
      
      if (shouldShowCommunities) {
        jurisdictionCommunitiesWrap.classList.remove('mq-hidden');
      } else {
        jurisdictionCommunitiesWrap.classList.add('mq-hidden');
      }
    }
  };
  
  // Make updateConditionalFields globally accessible for autocomplete handler
  window.updateConditionalFields = updateConditionalFields;
  
  // Update effectiveness metric "Other" field visibility
  const updateEffectivenessMetricOther = function() {
    const metricDropdown = document.getElementById('mq_effectiveness_metric');
    const otherWrap = document.getElementById('mq_effectiveness_metric_other_wrap');
    
    if (!metricDropdown || !otherWrap) return;
    
    if (metricDropdown.value === 'Other') {
      otherWrap.classList.remove('mq-hidden');
    } else {
      otherWrap.classList.add('mq-hidden');
    }
  };
  
  // Update applicant organization "Other" field visibility
  const updateApplicantOrganizationOther = function() {
    const orgDropdown = document.getElementById('mq_applicant_organization');
    const otherWrap = document.getElementById('mq_applicant_organization_other_wrap');
    
    if (!orgDropdown || !otherWrap) return;
    
    const selectedValue = orgDropdown.value;
    
    // Show if "Not listed" is selected (handles both hardcoded and dynamic values)
    if (selectedValue === 'NOT_LISTED' || 
        selectedValue === 'Not listed (vendor registration required prior to award)') {
      otherWrap.classList.remove('mq-hidden');
    } else {
      otherWrap.classList.add('mq-hidden');
    }
  };
  
  // Validate phone number format
  const validatePhoneNumber = function(phoneNumber) {
    if (!phoneNumber) return false;
    // Remove all non-digit characters for counting
    const digitsOnly = phoneNumber.replace(/\D/g, '');
    // Must have at least 10 digits (US phone number)
    if (digitsOnly.length < 10) return false;
    // Allow common phone number formats with digits, spaces, dashes, dots, and parentheses
    const phonePattern = /^[\d\s\-\.\(\)]+$/;
    return phonePattern.test(phoneNumber);
  };
  
  // Validate email format
  const validateEmail = function(email) {
    if (!email) return false;
    // Standard email validation pattern
    const emailPattern = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;
    return emailPattern.test(email);
  };
  
  // Validate Tier 1 funding limit (max $50,000)
  const validateTier1FundingLimit = function() {
    const projectTypeField = document.getElementById('mq_project_type');
    const fundingField = document.getElementById('mq_total_funding_requested_usd');
    const warningDiv = document.getElementById('mq_tier1_funding_warning');
    
    if (!projectTypeField || !fundingField || !warningDiv) return true;
    
    const projectType = projectTypeField.value;
    const fundingAmount = parseFloat(fundingField.value) || 0;
    
    // Only validate for Tier 1 projects
    if (projectType === 'Tier 1 Community Catalyst Grant') {
      if (fundingAmount > 50000) {
        warningDiv.classList.remove('mq-hidden');
        return false;
      } else {
        warningDiv.classList.add('mq-hidden');
        return true;
      }
    } else {
      // For non-Tier 1 projects, hide warning and return valid
      warningDiv.classList.add('mq-hidden');
      return true;
    }
  };
  
  // Word count function for executive summary
  const countWords = function(text) {
    if (!text || text.trim() === '') return 0;
    // Split by whitespace and filter out empty strings
    return text.trim().split(/\s+/).filter(function(word) {
      return word.length > 0;
    }).length;
  };
  
  // Update project title word count and enforce limit
  const updateProjectTitleWordCount = function() {
    const textarea = document.getElementById('mq_project_title');
    const wordCountDisplay = document.getElementById('mq_project_title_word_count');
    
    if (!textarea || !wordCountDisplay) return;
    
    const text = textarea.value;
    const wordCount = countWords(text);
    const maxWords = 30;
    
    // Update display
    wordCountDisplay.textContent = wordCount + ' / ' + maxWords + ' words';
    
    // Add/remove limit class for red styling
    if (wordCount >= maxWords) {
      wordCountDisplay.classList.add('mq-word-count-limit');
      textarea.classList.add('mq-word-limit-reached');
    } else {
      wordCountDisplay.classList.remove('mq-word-count-limit');
      textarea.classList.remove('mq-word-limit-reached');
    }
  };
  
  // Update executive summary word count and enforce limit
  const updateExecutiveSummaryWordCount = function() {
    const textarea = document.getElementById('mq_executive_summary');
    const wordCountDisplay = document.getElementById('mq_executive_summary_word_count');
    
    if (!textarea || !wordCountDisplay) return;
    
    const text = textarea.value;
    const wordCount = countWords(text);
    const maxWords = 250;
    
    // Update display
    wordCountDisplay.textContent = wordCount + ' / ' + maxWords + ' words';
    
    // Add/remove limit class for red styling
    if (wordCount >= maxWords) {
      wordCountDisplay.classList.add('mq-word-count-limit');
      textarea.classList.add('mq-word-limit-reached');
    } else {
      wordCountDisplay.classList.remove('mq-word-count-limit');
      textarea.classList.remove('mq-word-limit-reached');
    }
  };
  
  // Update project readiness delays word count and enforce limit
  const updateProjectReadinessDelaysWordCount = function() {
    const textarea = document.getElementById('mq_project_readiness_delays');
    const wordCountDisplay = document.getElementById('mq_project_readiness_delays_word_count');
    
    if (!textarea || !wordCountDisplay) return;
    
    const text = textarea.value;
    const wordCount = countWords(text);
    const maxWords = 300;
    
    // Update display
    wordCountDisplay.textContent = wordCount + ' / ' + maxWords + ' words';
    
    // Add/remove limit class for red styling
    if (wordCount >= maxWords) {
      wordCountDisplay.classList.add('mq-word-count-limit');
      textarea.classList.add('mq-word-limit-reached');
    } else {
      wordCountDisplay.classList.remove('mq-word-count-limit');
      textarea.classList.remove('mq-word-limit-reached');
    }
  };
  
  // Prevent input when word limit is reached
  const enforceWordLimit = function(event) {
    const textarea = event.target;
    const text = textarea.value;
    const wordCount = countWords(text);
    const maxWords = 250;
    
    // If at or over limit, prevent adding more words
    if (wordCount >= maxWords) {
      // Get the current selection/cursor position
      const cursorPos = textarea.selectionStart;
      
      // Get text before and after cursor
      const textBefore = text.substring(0, cursorPos);
      const textAfter = text.substring(cursorPos);
      
      // Count words before cursor
      const wordsBefore = countWords(textBefore);
      
      // If trying to add text that would increase word count, prevent it
      if (wordsBefore >= maxWords) {
        // Keep only text up to the last valid word boundary
        const words = text.trim().split(/\s+/).slice(0, maxWords);
        textarea.value = words.join(' ');
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        event.preventDefault();
        return false;
      }
      
      // If pasting or typing would add words, truncate
      const newText = textBefore + (event.data || '') + textAfter;
      const newWordCount = countWords(newText);
      
      if (newWordCount > maxWords) {
        // Truncate to max words
        const words = newText.trim().split(/\s+/).slice(0, maxWords);
        textarea.value = words.join(' ');
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        event.preventDefault();
        return false;
      }
    }
  };
  
  // Calculate budget row totals
  const calculateBudgetRowTotal = function(category) {
    const measureq = parseFloat(document.getElementById('mq_budget_' + category + '_measureq').value) || 0;
    const match = parseFloat(document.getElementById('mq_budget_' + category + '_match').value) || 0;
    const inkind = parseFloat(document.getElementById('mq_budget_' + category + '_inkind').value) || 0;
    const total = measureq + match + inkind;
    const totalField = document.getElementById('mq_budget_' + category + '_total');
    if (totalField) {
      totalField.value = Math.round(total);
    }
    return total;
  };
  
  // Calculate all budget totals
  const calculateAllBudgetTotals = function() {
    const categories = ['personnel', 'fringe', 'travel', 'equipment', 'supplies', 'contractual', 'construction', 'other_direct', 'indirect'];
    let totalMeasureQ = 0;
    let totalMatch = 0;
    let totalInKind = 0;
    let grandTotal = 0;
    
    categories.forEach(function(category) {
      const measureq = parseFloat(document.getElementById('mq_budget_' + category + '_measureq').value) || 0;
      const match = parseFloat(document.getElementById('mq_budget_' + category + '_match').value) || 0;
      const inkind = parseFloat(document.getElementById('mq_budget_' + category + '_inkind').value) || 0;
      
      totalMeasureQ += measureq;
      totalMatch += match;
      totalInKind += inkind;
      
      calculateBudgetRowTotal(category);
    });
    
    grandTotal = totalMeasureQ + totalMatch + totalInKind;
    
    // Update total funding requested (Measure Q total) - always auto-calculated (read-only field)
    const totalFundingField = document.getElementById('mq_total_funding_requested_usd');
    if (totalFundingField) {
      totalFundingField.value = Math.round(totalMeasureQ);
    }
    
    // Update total project cost (grand total) - always auto-calculated (read-only field)
    const totalCostField = document.getElementById('mq_total_project_cost_usd');
    if (totalCostField) {
      totalCostField.value = Math.round(grandTotal);
    }
    
    // Validate Tier 1 funding limit after auto-calculation
    validateTier1FundingLimit();
  };
  
  // Attach budget calculation listeners
  const attachBudgetListeners = function() {
    const categories = ['personnel', 'fringe', 'travel', 'equipment', 'supplies', 'contractual', 'construction', 'other_direct', 'indirect'];
    const fields = ['measureq', 'match', 'inkind'];
    
    categories.forEach(function(category) {
      fields.forEach(function(field) {
        const input = document.getElementById('mq_budget_' + category + '_' + field);
        if (input) {
          input.addEventListener('input', function() {
            calculateAllBudgetTotals();
            saveDraft();
          });
          input.addEventListener('change', function() {
            calculateAllBudgetTotals();
            saveDraft();
          });
        }
      });
    });
    
    // Total fields are read-only and auto-calculated
    // Keep validation listener for Total Funding Requested (Tier 1 limit check)
    const totalFundingField = document.getElementById('mq_total_funding_requested_usd');
    if (totalFundingField) {
      // Validate Tier 1 funding limit when totals are recalculated
      // Note: field is readonly, so user can't manually edit, but validation still runs on calculation
      totalFundingField.addEventListener('change', function() {
        validateTier1FundingLimit();
      });
    }
  };
  
  // Attach event listeners to all mq- fields
  const attachListeners = function() {
    const inputs = document.querySelectorAll('[id^="mq_"]');
    inputs.forEach(function(input) {
      // Save on change
      input.addEventListener('change', saveDraft);
      input.addEventListener('input', saveDraft);
      
      // Special handling for project title word count
      if (input.id === 'mq_project_title') {
        input.addEventListener('input', function() {
          updateProjectTitleWordCount();
          saveDraft();
        });
        input.addEventListener('keydown', function(event) {
          // Allow backspace, delete, arrow keys, etc.
          const allowedKeys = [
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 
            'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'
          ];
          if (allowedKeys.indexOf(event.key) !== -1) {
            return true;
          }
          
          const wordCount = countWords(input.value);
          if (wordCount >= 30) {
            // Allow only if it's a control key or if it would reduce word count
            if (event.key.length === 1 && !event.ctrlKey && !event.metaKey) {
              event.preventDefault();
              return false;
            }
          }
        });
        input.addEventListener('paste', function(event) {
          event.preventDefault();
          const pastedText = (event.clipboardData || window.clipboardData).getData('text');
          const currentText = input.value;
          const cursorPos = input.selectionStart;
          const textBefore = currentText.substring(0, cursorPos);
          const textAfter = currentText.substring(input.selectionEnd);
          const newText = textBefore + pastedText + textAfter;
          const newWordCount = countWords(newText);
          
          if (newWordCount <= 30) {
            input.value = newText;
            const newCursorPos = cursorPos + pastedText.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
          } else {
            // Truncate to 30 words
            const words = newText.trim().split(/\s+/).slice(0, 30);
            input.value = words.join(' ');
            input.setSelectionRange(input.value.length, input.value.length);
          }
          updateProjectTitleWordCount();
          saveDraft();
        });
      }
      
      // Special handling for executive summary word count
      if (input.id === 'mq_executive_summary') {
        input.addEventListener('input', function() {
          updateExecutiveSummaryWordCount();
          saveDraft();
        });
        input.addEventListener('keydown', function(event) {
          // Allow backspace, delete, arrow keys, etc.
          const allowedKeys = [
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 
            'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'
          ];
          if (allowedKeys.indexOf(event.key) !== -1) {
            return true;
          }
          
          const wordCount = countWords(input.value);
          if (wordCount >= 250) {
            // Allow only if it's a control key or if it would reduce word count
            if (event.key.length === 1 && !event.ctrlKey && !event.metaKey) {
              event.preventDefault();
              return false;
            }
          }
        });
        input.addEventListener('paste', function(event) {
          event.preventDefault();
          const pastedText = (event.clipboardData || window.clipboardData).getData('text');
          const currentText = input.value;
          const cursorPos = input.selectionStart;
          const textBefore = currentText.substring(0, cursorPos);
          const textAfter = currentText.substring(input.selectionEnd);
          const newText = textBefore + pastedText + textAfter;
          const newWordCount = countWords(newText);
          
          if (newWordCount <= 250) {
            input.value = newText;
            const newCursorPos = cursorPos + pastedText.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
          } else {
            // Truncate to 250 words
            const words = newText.trim().split(/\s+/).slice(0, 250);
            input.value = words.join(' ');
            input.setSelectionRange(input.value.length, input.value.length);
          }
          updateExecutiveSummaryWordCount();
          saveDraft();
        });
      }
      
      // Special handling for project readiness delays word count
      if (input.id === 'mq_project_readiness_delays') {
        input.addEventListener('input', function() {
          updateProjectReadinessDelaysWordCount();
          saveDraft();
        });
        input.addEventListener('keydown', function(event) {
          // Allow backspace, delete, arrow keys, etc.
          const allowedKeys = [
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 
            'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'
          ];
          if (allowedKeys.indexOf(event.key) !== -1) {
            return true;
          }
          
          const wordCount = countWords(input.value);
          if (wordCount >= 300) {
            // Allow only if it's a control key or if it would reduce word count
            if (event.key.length === 1 && !event.ctrlKey && !event.metaKey) {
              event.preventDefault();
              return false;
            }
          }
        });
        input.addEventListener('paste', function(event) {
          event.preventDefault();
          const pastedText = (event.clipboardData || window.clipboardData).getData('text');
          const currentText = input.value;
          const cursorPos = input.selectionStart;
          const textBefore = currentText.substring(0, cursorPos);
          const textAfter = currentText.substring(input.selectionEnd);
          const newText = textBefore + pastedText + textAfter;
          const newWordCount = countWords(newText);
          
          if (newWordCount <= 300) {
            input.value = newText;
            const newCursorPos = cursorPos + pastedText.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
          } else {
            // Truncate to 300 words
            const words = newText.trim().split(/\s+/).slice(0, 300);
            input.value = words.join(' ');
            input.setSelectionRange(input.value.length, input.value.length);
          }
          updateProjectReadinessDelaysWordCount();
          saveDraft();
        });
      }
      
      // Special handling for project type dropdown
      if (input.id === 'mq_project_type') {
        // Attempt to load dropdown values from API when the user interacts with the field.
        input.addEventListener('focus', function() {
          loadProjectTypeOptionsFromApi();
        });
        input.addEventListener('mousedown', function() {
          loadProjectTypeOptionsFromApi();
        });
        input.addEventListener('change', function() {
          updateStatusSection();
          validateTier1FundingLimit();
          saveDraft();
        });
      }
      
      // Special handling for applicant organization dropdown
      if (input.id === 'mq_applicant_organization') {
        // Attempt to load dropdown values from API when the user interacts with the field.
        input.addEventListener('focus', function() {
          loadApplicantOrganizationOptionsFromApi();
        });
        input.addEventListener('mousedown', function() {
          loadApplicantOrganizationOptionsFromApi();
        });
        input.addEventListener('change', function() {
          updateApplicantOrganizationOther();
          saveDraft();
        });
      }
      
      // Special handling for jurisdiction checkboxes
      if (input.name === 'mq_project_jurisdiction[]') {
        input.addEventListener('change', function() {
          updateConditionalFields();
          saveDraft();
        });
      }
      
      // Special handling for effectiveness metric dropdown
      if (input.id === 'mq_effectiveness_metric') {
        input.addEventListener('change', function() {
          updateEffectivenessMetricOther();
          saveDraft();
        });
      }
      
      // Special handling for primary contact phone validation and formatting
      if (input.id === 'mq_primary_contact_phone') {
        // Auto-format phone number as user types
        input.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, ''); // Remove all non-digits
          let formattedValue = '';
          
          if (value.length > 0) {
            // Format: (123) 456-7890
            if (value.length <= 3) {
              formattedValue = '(' + value;
            } else if (value.length <= 6) {
              formattedValue = '(' + value.slice(0, 3) + ') ' + value.slice(3);
            } else {
              formattedValue = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
            }
          }
          
          e.target.value = formattedValue;
          
          // Clear error on input if valid
          if (formattedValue && validatePhoneNumber(formattedValue)) {
            input.classList.remove('mq-input-error');
            const errorDiv = document.getElementById('mq_primary_contact_phone_error');
            if (errorDiv) errorDiv.style.display = 'none';
          }
        });
        
        input.addEventListener('blur', function() {
          const value = input.value.trim();
          const errorDiv = document.getElementById('mq_primary_contact_phone_error');
          
          if (value && !validatePhoneNumber(value)) {
            input.classList.add('mq-input-error');
            if (errorDiv) errorDiv.style.display = 'block';
          } else {
            input.classList.remove('mq-input-error');
            if (errorDiv) errorDiv.style.display = 'none';
          }
        });
      }
      
      // Special handling for primary contact email validation
      if (input.id === 'mq_primary_contact_email') {
        input.addEventListener('blur', function() {
          const value = input.value.trim();
          const errorDiv = document.getElementById('mq_primary_contact_email_error');
          
          if (value && !validateEmail(value)) {
            input.classList.add('mq-input-error');
            if (errorDiv) errorDiv.style.display = 'block';
          } else {
            input.classList.remove('mq-input-error');
            if (errorDiv) errorDiv.style.display = 'none';
          }
        });
        
        input.addEventListener('input', function() {
          // Clear error on input if valid
          const value = input.value.trim();
          if (value && validateEmail(value)) {
            input.classList.remove('mq-input-error');
            const errorDiv = document.getElementById('mq_primary_contact_email_error');
            if (errorDiv) errorDiv.style.display = 'none';
          }
        });
      }
    });
    
    // Set up environmental doc status radio buttons
    const envDocRadios = document.querySelectorAll('input[name="mq_env_doc_status"]');
    envDocRadios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        updateEnvironmentalDocDates();
        saveDraft();
      });
    });
    
    // Set up environmental date field formatting and validation
    const envDateFields = [
      'mq_env_doc_initial_study_date',
      'mq_env_doc_negative_declaration_date',
      'mq_env_doc_categorically_exempt_date',
      'mq_env_doc_in_process_date',
      'mq_env_doc_completed_date'
    ];
    
    envDateFields.forEach(function(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        // Format as user types (only allow digits, auto-format as YYYY-MM-DD)
        field.addEventListener('input', function(e) {
          formatDateInput(e.target);
          saveDraft();
        });
        
        // Validate on blur
        field.addEventListener('blur', function(e) {
          const value = e.target.value.trim();
          if (value && !validateDateFormat(value)) {
            e.target.classList.add('mq-input-error');
            alert('Please enter a valid date in YYYY-MM-DD format (e.g., 2026-01-21).');
            // Use setTimeout to ensure focus happens after alert dialog closes
            setTimeout(function() {
              e.target.focus();
              e.target.select(); // Select the text so user can easily replace it
            }, 0);
          } else {
            e.target.classList.remove('mq-input-error');
          }
        });
        
        // Allow paste and handle it properly
        field.addEventListener('paste', function(e) {
          // Let the paste happen first, then format it
          setTimeout(function() {
            formatDateInput(e.target);
          }, 0);
        });
      }
    });
    
    // Special handling for DAC/SDAC conditional field
    const isDacSdacField = document.getElementById('mq_is_dac_sdac');
    if (isDacSdacField) {
      isDacSdacField.addEventListener('change', function() {
        updateDacSdacFields();
        saveDraft();
      });
    }
  };
  
  // Validate all required fields (for Save and Continue only)
  const validateRequiredFields = function() {
    const missingFields = [];
    
    // Check text/select inputs with red asterisks
    const requiredFieldIds = [
      'mq_project_type',
      'mq_project_title',
      'mq_applicant_organization',
      'mq_primary_contact_name',
      'mq_primary_contact_title',
      'mq_primary_contact_phone',
      'mq_primary_contact_email',
      'mq_project_location',
      'mq_project_service_location',
      'mq_permit_preparations',
      'mq_project_duration',
      'mq_duration_amount',
      'mq_can_start_upon_award',
      'mq_project_readiness_delays',
      'mq_effectiveness_metric',
      'mq_effectiveness_metric_base_value',
      'mq_total_funding_requested_usd',
      'mq_executive_summary'
    ];
    
    // Check each required field
    requiredFieldIds.forEach(function(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        const value = field.value ? field.value.trim() : '';
        if (!value) {
          const label = document.querySelector('label[for="' + fieldId + '"]');
          const fieldName = label ? label.textContent.replace('*', '').trim() : fieldId;
          missingFields.push(fieldName);
        }
      }
    });
    
    // Check Project Jurisdiction checkboxes (at least one must be checked)
    const jurisdictionCheckboxes = document.querySelectorAll('input[name="mq_project_jurisdiction[]"]');
    let hasJurisdiction = false;
    jurisdictionCheckboxes.forEach(function(cb) {
      if (cb.checked) hasJurisdiction = true;
    });
    if (!hasJurisdiction) {
      missingFields.push('Project Jurisdiction / City (at least one)');
    }
    
    // Check Environmental Documentation radio buttons (one must be selected)
    const envRadios = document.querySelectorAll('input[name="mq_env_doc_status"]:checked');
    if (envRadios.length === 0) {
      missingFields.push('Environmental Documentation Status');
    }
    
    // Check Permits table (at least one permit must have a selection - Yes, No, NA, or Not sure)
    const permitRadios = document.querySelectorAll('input[name^="mq_perm_"]:not([name$="_comment"]):not([name$="_status"]):checked');
    if (permitRadios.length === 0) {
      missingFields.push('Permits Necessary for Project Implementation (at least one)');
    }
    
    return missingFields;
  };

  // Save Draft button handler - saves to both localStorage and API
  const handleSaveDraft = async function() {
    // Validate phone and email format if provided
    const phoneField = document.getElementById('mq_primary_contact_phone');
    const emailField = document.getElementById('mq_primary_contact_email');
    
    if (phoneField && phoneField.value.trim()) {
      if (!validatePhoneNumber(phoneField.value.trim())) {
        phoneField.classList.add('mq-input-error');
        const errorDiv = document.getElementById('mq_primary_contact_phone_error');
        if (errorDiv) errorDiv.style.display = 'block';
        phoneField.focus();
        alert('Please enter a valid phone number with at least 10 digits.');
        return;
      }
    }
    
    if (emailField && emailField.value.trim()) {
      if (!validateEmail(emailField.value.trim())) {
        emailField.classList.add('mq-input-error');
        const errorDiv = document.getElementById('mq_primary_contact_email_error');
        if (errorDiv) errorDiv.style.display = 'block';
        emailField.focus();
        alert('Please enter a valid email address (e.g., email@example.com).');
        return;
      }
    }
    
    // Save to localStorage first
    saveDraft();
    
    // Show loading state
    const saveDraftBtn = document.getElementById('mq_save_draft_btn');
    const originalText = saveDraftBtn ? saveDraftBtn.textContent : '';
    if (saveDraftBtn) {
      saveDraftBtn.disabled = true;
      saveDraftBtn.textContent = 'Saving...';
    }
    
    try {
      // Check if we have an existing application record (update) or need to create new
      const applicationRecordId = localStorage.getItem('mq_current_application_id');
      const isUpdate = !!applicationRecordId;
      
      // Submit to all tables (no nextPageURL for draft)
      const result = await submitCompleteApplication(null, isUpdate);
      
      // Restore button state
      if (saveDraftBtn) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = originalText;
      }
      
      if (result && result.success) {
        if (result.errors.length > 0) {
          // Check if API error
          const apiError = result.errors.find(function(e) { return e.table === 'API'; });
          if (apiError) {
            alert('✅ Draft saved to your browser!\n\n⚠️ API connection unavailable (token issue).\nYour data is safe in localStorage.\n\nPlease contact your administrator about the authentication token.');
          } else {
            const failedTables = result.errors.map(function(e) { return e.table; }).join(', ');
            alert('Draft saved with some errors in: ' + failedTables + '. Main application was saved successfully.');
          }
        } else {
          alert('✅ Draft saved successfully to all tables!');
        }
      } else {
        // API not configured or token unavailable - still show success (saved to localStorage)
        console.log('Draft saved to localStorage (API not configured)');
        alert('✅ Draft saved to your browser!\n\n⚠️ API not available.\nYour data is safe in localStorage.');
      }
    } catch (error) {
      // Restore button state
      if (saveDraftBtn) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = originalText;
      }
      
      console.error('Error saving draft to API:', error);
      // Still show success since localStorage was saved
      alert('Draft saved locally. There was an error saving to the API, but your data is safe.');
    }
  };
  
  // Project Type to Next Page URL mapping
  const PROJECT_STAGE_URLS = {
    'Tier 1 Community Catalyst Grant': 'https://apps.opengov.com/apps/4rtlvxxg7/settings/user-interface/pages/view/kvk7idwg7',
    'Tier 2 Community Impact Grants': 'https://apps.opengov.com/apps/4rtlvxxg7/settings/user-interface/pages/view/ydj29ozg2',
    'Tier 2 Pajaro Valley Set-Aside': 'https://apps.opengov.com/apps/4rtlvxxg7/settings/user-interface/pages/view/ydj29ozg2',
    'Tier 2 San Vicente Redwoods Set-Aside': 'https://apps.opengov.com/apps/4rtlvxxg7/settings/user-interface/pages/view/ydj29ozg2'
  };
  
  // Resolve next page URL based on project type
  const resolveNextPageUrl = function(projectType) {
    if (!projectType) {
      return null;
    }
    return PROJECT_STAGE_URLS[projectType] || null;
  };
  
  // Note: persistApplicationData function has been replaced by submitCompleteApplication
  // which handles multi-table submissions properly
  
  const handleSaveAndContinue = async function() {
    // Validate all required fields first
    const missingFields = validateRequiredFields();
    if (missingFields.length > 0) {
      alert('Please complete all required fields before continuing:\n\n' + missingFields.join('\n'));
      return;
    }
    
    // Validate phone and email format (they are required, so must be filled at this point)
    const phoneField = document.getElementById('mq_primary_contact_phone');
    const emailField = document.getElementById('mq_primary_contact_email');
    
    if (phoneField && phoneField.value.trim()) {
      if (!validatePhoneNumber(phoneField.value.trim())) {
        phoneField.classList.add('mq-input-error');
        const errorDiv = document.getElementById('mq_primary_contact_phone_error');
        if (errorDiv) errorDiv.style.display = 'block';
        phoneField.focus();
        alert('Please enter a valid phone number with at least 10 digits.');
        return;
      }
    }
    
    if (emailField && emailField.value.trim()) {
      if (!validateEmail(emailField.value.trim())) {
        emailField.classList.add('mq-input-error');
        const errorDiv = document.getElementById('mq_primary_contact_email_error');
        if (errorDiv) errorDiv.style.display = 'block';
        emailField.focus();
        alert('Please enter a valid email address (e.g., email@example.com).');
        return;
      }
    }
    
    // Save draft before redirecting
    saveDraft();
    
    // Get the selected project type to determine next page
    const projectTypeField = document.getElementById('mq_project_type');
    const projectType = projectTypeField ? projectTypeField.value : '';
    
    // Resolve the next page URL based on project type
    const nextPageUrl = resolveNextPageUrl(projectType);
    
    if (!nextPageUrl) {
      alert('Please select a Project Type and then try saving again.');
      return;
    }
    
    // Show loading state
    const saveBtn = document.getElementById('mq_save_and_continue_btn');
    const originalText = saveBtn ? saveBtn.textContent : '';
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
    }
    
    try {
      // Check if we have an existing application record (update) or need to create new
      const applicationRecordId = localStorage.getItem('mq_current_application_id');
      const isUpdate = !!applicationRecordId;
      
      // Submit to all tables (with nextPageURL for resume_url navigation)
      const result = await submitCompleteApplication(nextPageUrl, isUpdate);
      
      if (result && result.success) {
        // Save nextPageURL to localStorage as backup
        localStorage.setItem('measure_q_next_stage_url', nextPageUrl);
        
        // Redirect to the appropriate page
        // Use window.top to break out of iframe and redirect the entire browser window
        window.top.location.href = nextPageUrl;
      } else {
        throw new Error('Failed to submit application data');
      }
    } catch (error) {
      // Restore button state
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
      
      // Show error but still allow redirect (data saved to localStorage as fallback)
      console.error('Error saving to API:', error);
      const proceed = confirm('There was an error saving to the API. Your data has been saved locally. Would you like to continue anyway?');
      
      if (proceed) {
        // Save nextPageURL to localStorage as fallback
        localStorage.setItem('measure_q_next_stage_url', nextPageUrl);
        window.top.location.href = nextPageUrl;
      }
    }
  };
  
  // Attach button handlers
  // Download as PDF handler - uses browser's native print function
  const handleDownloadPDF = function() {
    // Use the browser's native print dialog, which can save as PDF
    // This provides much better page break handling than html2pdf.js
    window.print();
  };
  
  const attachButtonHandlers = function() {
    const saveDraftBtn = document.getElementById('mq_save_draft_btn');
    const saveAndContinueBtn = document.getElementById('mq_save_and_continue_btn');
    const downloadPdfBtn = document.getElementById('mq_download_pdf_btn');
    
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', handleSaveDraft);
    }
    
    if (saveAndContinueBtn) {
      saveAndContinueBtn.addEventListener('click', handleSaveAndContinue);
    }
    
    if (downloadPdfBtn) {
      downloadPdfBtn.addEventListener('click', handleDownloadPDF);
    }
  };
  
  // Initialize on DOM ready
  const init = function() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async function() {
        // Check for recordId in URL parameter (from navigation back from Tier pages)
        const urlParams = new URLSearchParams(window.location.search);
        const urlRecordId = urlParams.get('recordId');
        
        // If recordId is in URL, store it in localStorage
        if (urlRecordId) {
          localStorage.setItem('mq_current_application_id', urlRecordId);
          console.log('[MeasureQ] Record ID from URL:', urlRecordId);
        }
        
        // Populate Record ID field from localStorage
        console.log('[MeasureQ] 🔍 Page loaded, checking localStorage for record ID...');
        const recordId = localStorage.getItem('mq_current_application_id');
        console.log('[MeasureQ] 📋 Record ID from localStorage:', recordId);
        
        if (recordId) {
          const recordIdField = document.getElementById('mq_record_id');
          if (recordIdField) {
            recordIdField.value = recordId;
            console.log('[MeasureQ] ✓ Set record ID field to:', recordId);
          }
        } else {
          console.log('[MeasureQ] ⚠️ No record ID in localStorage - this is a NEW application');
        }
        
        // Load from API first (most recent saved data), then localStorage as fallback
        const loadedFromAPI = await loadFromAPI();
        
        // Only load from localStorage if API didn't load data
        if (!loadedFromAPI) {
          console.log('[MeasureQ] Loading from localStorage as fallback');
          loadDraft();
        } else {
          console.log('[MeasureQ] Skipping localStorage load - data loaded from API');
        }
        
        updateStatusSection();
        updateConditionalFields();
        updateEnvironmentalDocDates();
        updateDacSdacFields();
        updateEffectivenessMetricOther();
        updateApplicantOrganizationOther();
        validateTier1FundingLimit();
        attachListeners();
        loadProjectTypeOptionsFromApi();
        loadApplicantOrganizationOptionsFromApi();
        attachBudgetListeners();
        calculateAllBudgetTotals();
        updateProjectTitleWordCount();
        updateExecutiveSummaryWordCount();
        updateProjectReadinessDelaysWordCount();
        attachButtonHandlers();
        attachPortalUserModalListeners();
        renderPortalUsersTable();
      });
    } else {
      // Document already loaded - run initialization immediately
      (async function() {
        // Check for recordId in URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlRecordId = urlParams.get('recordId');
        
        if (urlRecordId) {
          localStorage.setItem('mq_current_application_id', urlRecordId);
          console.log('[MeasureQ] Record ID from URL:', urlRecordId);
        }
        
        // Populate Record ID field
        const recordId = localStorage.getItem('mq_current_application_id');
        if (recordId) {
          const recordIdField = document.getElementById('mq_record_id');
          if (recordIdField) {
            recordIdField.value = recordId;
          }
        }
        
        // Load from API first, then localStorage as fallback
        const loadedFromAPI = await loadFromAPI();
        
        if (!loadedFromAPI) {
          console.log('[MeasureQ] Loading from localStorage as fallback');
          loadDraft();
        } else {
          console.log('[MeasureQ] Skipping localStorage load - data loaded from API');
        }
        
        updateStatusSection();
        updateConditionalFields();
        updateEnvironmentalDocDates();
        updateDacSdacFields();
        updateEffectivenessMetricOther();
        updateApplicantOrganizationOther();
        validateTier1FundingLimit();
        attachListeners();
        loadProjectTypeOptionsFromApi();
        loadApplicantOrganizationOptionsFromApi();
        attachBudgetListeners();
        calculateAllBudgetTotals();
        updateProjectTitleWordCount();
        updateExecutiveSummaryWordCount();
        updateProjectReadinessDelaysWordCount();
        attachButtonHandlers();
        attachPortalUserModalListeners();
        renderPortalUsersTable();
      })();
    }
  };
  
  init();
})();
</script>
